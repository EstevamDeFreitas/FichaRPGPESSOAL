<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de RPG</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input:focus {
      outline: none !important;
      box-shadow: none !important;
      border-top: 0 !important;
      border-left: 0 !important;
      border-right: 0 !important;
      border-radius: 0 !important;
    }
    textarea {
      border: 2px solid #d1d5db; /* gray-300 */
      border-radius: 0.5rem;
      background: #fff;
      transition: border-color 0.2s;
      resize: none;
    }
    textarea:focus {
      border-color: #3b82f6 !important; /* blue-500 */
      outline: none !important;
      box-shadow: none !important;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-md">
    <h1 class="text-2xl font-bold mb-4 text-center">üìú Ficha de RPG</h1>

    <!-- Dados b√°sicos -->
    <div class="mb-6">
      <div class="flex gap-6 items-start">
        <!-- Imagem do personagem -->
        <div class="flex flex-col items-center w-40 shrink-0">
          <label for="imagemPersonagem" class="block font-semibold mb-2">Imagem</label>
          <div class="border-2 border-dashed border-gray-300 rounded-full w-32 h-32 flex items-center justify-center overflow-hidden bg-gray-50">
            <img id="previewImagem" class="hidden object-cover w-32 h-32" alt="Preview">
          </div>
          <input type="file" id="imagemPersonagem" name="imagemPersonagem" accept="image/*" class="hidden">
          <button type="button" onclick="document.getElementById('imagemPersonagem').click()" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs">Escolher Imagem</button>
          <button id="removerImagem" type="button" onclick="removerImagem()" class="mt-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs hidden">Remover</button>
        </div>
        <!-- Inputs principais -->
        <div class="flex-1 grid grid-cols-4 gap-4">
          <div class="col-span-3">
            <label for="nome" class="block font-semibold">Nome</label>
            <input id="nome" name="nome" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm mb-2 bg-transparent">
          </div>
          <div class="col-span-1">
            <label for="apelido" class="block font-semibold">Apelido</label>
            <input id="apelido" name="apelido" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm mb-2 bg-transparent">
          </div>
          <div class="col-span-2">
            <label for="vocacao" class="block font-semibold">Voca√ß√£o</label>
            <input id="vocacao" name="vocacao" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div class="col-span-2">
            <label for="especie" class="block font-semibold">Esp√©cie</label>
            <input id="especie" name="especie" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="idade" class="block font-semibold">Idade</label>
            <input id="idade" name="idade" type="number" min="0" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="altura" class="block font-semibold">Altura</label>
            <input id="altura" name="altura" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="genero" class="block font-semibold">G√™nero</label>
            <input id="genero" name="genero" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="alinhamento" class="block font-semibold">Alinhamento</label>
            <input id="alinhamento" name="alinhamento" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          
          <div>
            <!-- Personalidade removida daqui, agora est√° em Backstory -->
          </div>
          <div>
            <label for="vidaAtual" class="block font-semibold">Vida Atual</label>
            <input id="vidaAtual" name="vidaAtual" type="number" min="0" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="vidaMaxima" class="block font-semibold">Vida M√°xima</label>
            <input id="vidaMaxima" name="vidaMaxima" type="number" min="0" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
        </div>
      </div>
      <br>
      <div class="border-2 border-gray-300 rounded-xl p-4 bg-gray-50 ">
          <h2 class="text-xl font-bold mb-2">üìù Backstory</h2>
          <div class="mb-4">
            <label for="personalidade" class="block font-semibold mb-1">Personalidade</label>
            <textarea id="personalidade" name="personalidade" rows="2" class="w-full p-2 text-sm"></textarea>
          </div>
            <div class="mb-4">
              <label for="historia" class="block font-semibold mb-1">Hist√≥ria</label>
              <textarea id="historia" name="historia" rows="4" class="w-full p-2 text-sm"></textarea>
            </div>
            <div>
              <label for="observacoes" class="block font-semibold mb-1">Observa√ß√µes</label>
              <textarea id="observacoes" name="observacoes" rows="2" class="w-full p-2 text-sm"></textarea>
            </div>
        </div>
    <!-- Per√≠cias -->
    <div class="mt-8 flex gap-4">
      <div class="flex flex-col gap-6">
        <div class="border-2 border-gray-300 rounded-xl p-4 bg-gray-50 max-w-xl">
          <h2 class="text-xl font-bold mb-2">üé≤ Per√≠cias</h2>
          <div id="periciasContainer" class="space-y-6"></div>
        </div>
        
      </div>
    </div>

    <!-- Bot√µes -->
    <div class="flex gap-4 justify-center mt-6 flex-wrap">
      <button onclick="limparFicha()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl">Limpar</button>
      <button onclick="exportarFicha()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-xl">Exportar</button>
      <input type="file" id="importarInput" name="importarInput" accept=".json" class="hidden" onchange="importarFicha(event)">
      <button onclick="document.getElementById('importarInput').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl">Importar</button>
    </div>

    <!-- Bot√£o fixo de rolagem de dados -->
  <button id="rolarDadosBtn" title="Rolar Dados" class="fixed right-0 top-1/2 z-50 bg-blue-600 hover:bg-blue-700 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-blue-800" style="transform: translateY(-50%);">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061A1.125 1.125 0 0 1 3 16.811V8.69ZM12.75 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061a1.125 1.125 0 0 1-1.683-.977V8.69Z" />
        </svg>
    </button>

    <!-- Modal de rolagem de dados -->
    <div id="modalRolarDados" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
        <button id="fecharModalRolar" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span>üé≤</span> Rolar Dados de Per√≠cia</h2>
        <div class="mb-4">
          <label for="selectPericia" class="block font-semibold mb-1">Per√≠cia</label>
          <select id="selectPericia" name="selectPericia" class="w-full border rounded p-1.5 text-sm">
            <option value="">Selecione...</option>
          </select>
        </div>
        <div class="mb-4" id="divHabilidadeInterna" style="display:none;">
          <label for="selectHabilidadeInterna" class="block font-semibold mb-1">Habilidade</label>
          <select id="selectHabilidadeInterna" name="selectHabilidadeInterna" class="w-full border rounded p-1.5 text-sm"></select>
        </div>
        <button id="btnRolar" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl w-full font-bold">Rolar Dados</button>
        <div id="resultadoRolagem" class="mt-4 text-center text-lg font-semibold"></div>
      </div>
    </div>

  <script>
    // --- IMAGEM DO PERSONAGEM ---
    function compressImage(file, maxWidth, quality, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          let width = img.width;
          let height = img.height;
          if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
          }
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob((blob) => {
            const reader2 = new FileReader();
            reader2.onload = (e) => {
              callback(e.target.result);
            };
            reader2.readAsDataURL(blob);
          }, 'image/jpeg', quality);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        compressImage(file, 600, 0.7, (base64) => {
          document.getElementById('previewImagem').src = base64;
          document.getElementById('previewImagem').classList.remove('hidden');
          document.getElementById('removerImagem').classList.remove('hidden');
        });
      }
    }

    function removerImagem() {
      document.getElementById('previewImagem').src = '';
      document.getElementById('previewImagem').classList.add('hidden');
      document.getElementById('removerImagem').classList.add('hidden');
      document.getElementById('imagemPersonagem').value = '';
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('imagemPersonagem').addEventListener('change', handleImageUpload);
      
      // Carrega a ficha salva no localStorage, se existir
      const fichaSalva = localStorage.getItem('fichaRPG');
      if (fichaSalva) {
        try {
          const ficha = JSON.parse(fichaSalva);
          preencherFicha(ficha);
        } catch (e) {
          console.error('Erro ao carregar ficha salva:', e);
        }
      }
      
      // Certifica-se de que as per√≠cias s√£o renderizadas corretamente
      renderPericias();
    });
    const pericias = [
      { icon: 'üí™', nome: 'Corpo', habilidades: ['Atletismo', 'Briga', 'Agilidade', 'Resist√™ncia'] },
      { icon: 'üß†', nome: 'Mente', habilidades: ['Investiga√ß√£o', 'Conhecimento Geral', 'Conhecimento Espec√≠fico', 'Intui√ß√£o'] },
      { icon: 'üó£Ô∏è', nome: 'Social', habilidades: ['L√°bia', 'Intimida√ß√£o', 'Interpreta√ß√£o', 'Lideran√ßa'] },
      { icon: 'üõ†Ô∏è', nome: 'T√©cnica', habilidades: ['Mira/Precis√£o', 'Medicina/Of√≠cios', 'Magia/Manuseio', 'Furtividade'] }
    ];

    function renderPericias() {
      const container = document.getElementById('periciasContainer');
      // Salvar o estado atual dos checkboxes antes de limpar
      const estadoPericias = {};
      document.querySelectorAll('input[data-pericia]').forEach(cb => {
        const pericia = cb.dataset.pericia;
        const nivel = cb.dataset.nivel;
        if (!estadoPericias[pericia]) {
          estadoPericias[pericia] = {};
        }
        estadoPericias[pericia][nivel] = cb.checked;
      });
      
      // Salvar o estado atual dos textareas
      const estadoTextareas = {};
      document.querySelectorAll('textarea[data-pericia-especifica]').forEach(textarea => {
        estadoTextareas[textarea.dataset.periciaEspecifica] = textarea.value;
      });
      
      // Limpar o container
      container.innerHTML = '';

      // Lista de per√≠cias que devem ter campo de habilidades expans√≠vel
      const periciasComInput = ['Conhecimento Geral', 'Conhecimento Espec√≠fico', 'Of√≠cios', 'Medicina/Of√≠cios'];

      pericias.forEach(categoria => {
        // Calcular quantidade de dados em efeito para a categoria
        let temIntermediario = false;
        let contadorPericiasTreinadas = 0;
        let todasPericiasTreinadas = true; // Para verificar se todas as per√≠cias est√£o treinadas (pelo menos n√≠vel 1)
        
        categoria.habilidades.forEach(hab => {
          // Verifica se h√° per√≠cias treinadas (n√≠vel 1) ou avan√ßadas (n√≠vel 2 ou 3)
          let nivelHab = 0;
          if (estadoPericias[hab]) {
            // Verifica o maior n√≠vel marcado
            if (estadoPericias[hab]['3'] && estadoPericias[hab]['3'] === true) nivelHab = 3;
            else if (estadoPericias[hab]['2'] && estadoPericias[hab]['2'] === true) nivelHab = 2;
            else if (estadoPericias[hab]['1'] && estadoPericias[hab]['1'] === true) nivelHab = 1;
          }
          
          if (nivelHab >= 2) temIntermediario = true;
          if (nivelHab >= 1) contadorPericiasTreinadas++;
          else todasPericiasTreinadas = false; // Se alguma per√≠cia n√£o estiver treinada, marca como falso
        });
        
        let dadosTexto = '';
        let temDadoBonus = todasPericiasTreinadas && categoria.habilidades.length >= 4;
        // Exibi√ß√£o simplificada: mostra 3d10 se houver b√¥nus de dado
        if (temDadoBonus) {
          // Se for 2d10 (melhor) +1, mostra 3d10 (melhor)
          if (temIntermediario && contadorPericiasTreinadas >= 2) {
            dadosTexto = '3d10 (melhor)';
          }
          // Se for 1d10 +1, mostra 2d10
          else if (temIntermediario || contadorPericiasTreinadas >= 2) {
            dadosTexto = '2d10';
          }
          // Se for 2d10 (pior) +1, mostra 3d10 (pior)
          else {
            dadosTexto = '3d10 (pior)';
          }
        } else {
          if (temIntermediario && contadorPericiasTreinadas >= 2) {
            dadosTexto = '2d10 (melhor)';
          } else if (temIntermediario) {
            dadosTexto = '1d10';
          } else if (contadorPericiasTreinadas >= 2) {
            dadosTexto = '1d10';
          } else {
            dadosTexto = '2d10 (pior)';
          }
        }

        const bloco = document.createElement('div');
        bloco.innerHTML = `<h3 class=\"font-bold text-lg mb-2 flex items-center gap-2\">${categoria.icon} ${categoria.nome} <span class='text-xs font-normal bg-blue-100 text-blue-700 px-2 py-0.5 rounded'>${dadosTexto}</span></h3>`;

        categoria.habilidades.forEach(nome => {
          const linha = document.createElement('div');
          linha.className = 'flex flex-col gap-1 mb-1';

          // Wrapper para alinhar label, √≠cone e checkboxes
          const linhaSuperior = document.createElement('div');
          linhaSuperior.className = 'flex items-center gap-2';

          // Sempre reserva espa√ßo para o √≠cone (expans√≠vel ou placeholder invis√≠vel)
          let expandIcon = null;
          const isExpansivel = periciasComInput.includes(nome);

          if (isExpansivel) {
            expandIcon = document.createElement('span');
            expandIcon.innerHTML = '<svg class="inline w-4 h-4 transition-transform" style="vertical-align:middle" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>';
            expandIcon.className = 'text-gray-500 mr-1 select-none cursor-pointer';
          } else {
            expandIcon = document.createElement('span');
            expandIcon.innerHTML = '<svg class="inline w-4 h-4" style="opacity:0;vertical-align:middle" viewBox="0 0 24 24"></svg>';
            expandIcon.className = 'mr-1';
          }
          linhaSuperior.appendChild(expandIcon);

          const label = document.createElement('span');
          label.className = 'w-40 select-none' + (isExpansivel ? ' cursor-pointer' : '');
          label.textContent = nome;

          linhaSuperior.appendChild(label);

          for (let i = 1; i <= 3; i++) {
            const checkboxId = `pericia-${nome.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}-${i}`;
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.name = checkboxId;
            checkbox.className = 'w-5 h-5 accent-blue-500';
            checkbox.dataset.pericia = nome;
            checkbox.dataset.nivel = i;
            
            // Restaurar estado
            if (estadoPericias[nome] && estadoPericias[nome][i] !== undefined) {
              checkbox.checked = estadoPericias[nome][i];
            }
            
            checkbox.addEventListener('change', handleNivelSelection);
            linhaSuperior.appendChild(checkbox);
            
            // Add hidden label for accessibility
            const checkboxLabel = document.createElement('label');
            checkboxLabel.htmlFor = checkboxId;
            checkboxLabel.className = 'sr-only'; // Screen reader only
            
            // Adiciona descri√ß√£o do n√≠vel nos labels para acessibilidade
            let nivelDesc = '';
            if (i === 1) nivelDesc = "Treinado";
            else if (i === 2) nivelDesc = "Intermedi√°rio";
            else nivelDesc = "Mestre";
            checkboxLabel.textContent = `${nivelDesc} (N√≠vel ${i}) para ${nome}`;
            
            linhaSuperior.appendChild(checkboxLabel);
          }

          linha.appendChild(linhaSuperior);

          // Campo expans√≠vel para habilidades, se for uma das per√≠cias selecionadas
          if (isExpansivel) {
            // Cria o campo oculto inicialmente
            const habilidadesDiv = document.createElement('div');
            habilidadesDiv.className = 'hidden mt-2';
            habilidadesDiv.style.marginLeft = '1.5rem';

            // Label e textarea para m√∫ltiplas habilidades
            const habilidadesLabel = document.createElement('label');
            habilidadesLabel.textContent = '';
            habilidadesLabel.className = 'block text-sm font-medium mb-1';
            const textareaId = `habilidades-${nome.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}`;
            habilidadesLabel.setAttribute('for', textareaId);

            const habilidadesTextarea = document.createElement('textarea');
            habilidadesTextarea.id = textareaId;
            habilidadesTextarea.name = textareaId;
            habilidadesTextarea.rows = 2;
            habilidadesTextarea.placeholder = 'Digite uma habilidade por linha';
            habilidadesTextarea.className = 'w-full border rounded p-1 text-xs leading-tight';
            habilidadesTextarea.style.minHeight = '28px';
            habilidadesTextarea.dataset.periciaEspecifica = nome;
            
            // Restaurar o conte√∫do do textarea
            if (estadoTextareas[nome] !== undefined) {
              habilidadesTextarea.value = estadoTextareas[nome];
            }

            habilidadesDiv.appendChild(habilidadesLabel);
            habilidadesDiv.appendChild(habilidadesTextarea);

            linha.appendChild(habilidadesDiv);

            // Toggle ao clicar no nome ou √≠cone
            const toggleExpand = () => {
              habilidadesDiv.classList.toggle('hidden');
              if (expandIcon && isExpansivel) {
                expandIcon.querySelector('svg').style.transform = habilidadesDiv.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
              }
            };
            label.addEventListener('click', toggleExpand);
            if (expandIcon && isExpansivel) expandIcon.addEventListener('click', toggleExpand);
          }

          bloco.appendChild(linha);
        });

        container.appendChild(bloco);
      });
    }

    function handleNivelSelection(e) {
      const cb = e.target;
      const nivel = parseInt(cb.dataset.nivel);
      const pericia = cb.dataset.pericia;

      // Busca os checkboxes desta per√≠cia
      const checkboxes = document.querySelectorAll(`input[data-pericia="${pericia}"]`);
      
      if (cb.checked) {
        // Se o checkbox foi marcado, marque tamb√©m todos os n√≠veis inferiores
        checkboxes.forEach(c => {
          if (parseInt(c.dataset.nivel) <= nivel) {
            c.checked = true;
          }
        });
      } else {
        // Se o checkbox foi desmarcado, desmarque tamb√©m todos os n√≠veis superiores
        checkboxes.forEach(c => {
          if (parseInt(c.dataset.nivel) >= nivel) {
            c.checked = false;
          }
        });
      }
      
      // Salva o estado atual para n√£o perder ao renderizar
      const estadoAtual = {};
      document.querySelectorAll('input[data-pericia]').forEach(checkbox => {
        const pericName = checkbox.dataset.pericia;
        const pericNivel = checkbox.dataset.nivel;
        if (!estadoAtual[pericName]) {
          estadoAtual[pericName] = {};
        }
        estadoAtual[pericName][pericNivel] = checkbox.checked;
      });
      
      // Renderiza as per√≠cias para atualizar a exibi√ß√£o
      renderPericias();
      
      // Restaura o estado ap√≥s renderizar
      document.querySelectorAll('input[data-pericia]').forEach(checkbox => {
        const pericName = checkbox.dataset.pericia;
        const pericNivel = checkbox.dataset.nivel;
        if (estadoAtual[pericName] && estadoAtual[pericName][pericNivel] !== undefined) {
          checkbox.checked = estadoAtual[pericName][pericNivel];
        }
      });
    }

    function limparFicha() {
      localStorage.removeItem('fichaRPG');
      document.querySelectorAll('input, textarea').forEach(el => el.value = '');
      document.querySelectorAll('#periciasContainer input[type="checkbox"]').forEach(cb => cb.checked = false);
      alert('Ficha apagada.');
    }

    function exportarFicha() {
      const ficha = coletarFicha();
      const blob = new Blob([JSON.stringify(ficha, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${ficha.nome || 'ficha'}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importarFicha(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const ficha = JSON.parse(e.target.result);
          preencherFicha(ficha);
          localStorage.setItem('fichaRPG', JSON.stringify(ficha));
          alert('Ficha importada com sucesso!');
        } catch {
          alert('Arquivo inv√°lido.');
        }
      };
      reader.readAsText(file);
    }

    function coletarFicha() {
      const ficha = {
        nome: document.getElementById('nome').value,
        apelido: document.getElementById('apelido').value,
        idade: document.getElementById('idade').value,
        genero: document.getElementById('genero').value,
        alinhamento: document.getElementById('alinhamento').value,
        altura: document.getElementById('altura').value,
  personalidade: document.getElementById('personalidade').value,
  historia: document.getElementById('historia').value,
  observacoes: document.getElementById('observacoes').value,
        vocacao: document.getElementById('vocacao').value,
        especie: document.getElementById('especie').value,
        vidaAtual: document.getElementById('vidaAtual').value,
        vidaMaxima: document.getElementById('vidaMaxima').value,
        imagemPersonagem: document.getElementById('previewImagem').src || '',
        pericias: {},
        periciasEspecificas: {}
      };

      document.querySelectorAll('input[data-pericia]').forEach(cb => {
        const pericia = cb.dataset.pericia;
        const nivel = cb.dataset.nivel;
        
        if (!ficha.pericias[pericia]) {
          ficha.pericias[pericia] = {};
        }
        
        ficha.pericias[pericia][nivel] = cb.checked;
      });

      // Salva os valores dos campos de habilidades (textarea)
      document.querySelectorAll('textarea[data-pericia-especifica]').forEach(textarea => {
        ficha.periciasEspecificas[textarea.dataset.periciaEspecifica] = textarea.value;
      });

      return ficha;
    }

    function preencherFicha(ficha) {
      // Imagem do personagem
      if (ficha.imagemPersonagem) {
        document.getElementById('previewImagem').src = ficha.imagemPersonagem;
        document.getElementById('previewImagem').classList.remove('hidden');
        document.getElementById('removerImagem').classList.remove('hidden');
      } else {
        removerImagem();
      }
      document.getElementById('nome').value = ficha.nome || '';
      document.getElementById('apelido').value = ficha.apelido || '';
      document.getElementById('idade').value = ficha.idade || '';
      document.getElementById('genero').value = ficha.genero || '';
      document.getElementById('alinhamento').value = ficha.alinhamento || '';
      document.getElementById('altura').value = ficha.altura || '';
  document.getElementById('personalidade').value = ficha.personalidade || '';
  document.getElementById('historia').value = ficha.historia || '';
  document.getElementById('observacoes').value = ficha.observacoes || '';
      document.getElementById('vocacao').value = ficha.vocacao || '';
      document.getElementById('especie').value = ficha.especie || '';
      document.getElementById('vidaAtual').value = ficha.vidaAtual || 0;
      document.getElementById('vidaMaxima').value = ficha.vidaMaxima || 0;

      // Guarda o estado das per√≠cias para aplicar ap√≥s renderizar
      const estadoPericias = ficha.pericias || {};
      const estadoPericiasEspecificas = ficha.periciasEspecificas || {};

      // Renderiza as per√≠cias
      renderPericias();

      // Aplica o estado das per√≠cias ap√≥s renderizar
      setTimeout(() => {
        // Aplica o estado dos checkboxes
        document.querySelectorAll('input[data-pericia]').forEach(cb => {
          const pericia = cb.dataset.pericia;
          const nivel = cb.dataset.nivel;
          if (estadoPericias[pericia] && estadoPericias[pericia][nivel] !== undefined) {
            cb.checked = estadoPericias[pericia][nivel];
          }
        });
        // Aplica o valor dos textareas
        document.querySelectorAll('textarea[data-pericia-especifica]').forEach(textarea => {
          const pericia = textarea.dataset.periciaEspecifica;
          if (estadoPericiasEspecificas[pericia] !== undefined) {
            textarea.value = estadoPericiasEspecificas[pericia];
          }
        });
        // Chama renderPericias novamente para atualizar a exibi√ß√£o dos dados
        renderPericias();
      }, 50);
    }

    renderPericias();

    // --- ROLAGEM DE DADOS ---
    // Utilidades para rolagem
    function rolarD10() {
      return Math.floor(Math.random() * 10) + 1;
    }

    // Preencher selects do modal
    function preencherSelectPericia() {
      const select = document.getElementById('selectPericia');
      select.innerHTML = '<option value="">Selecione...</option>';
      // Adiciona op√ß√£o para rolar a categoria principal
      pericias.forEach(cat => {
        const optCat = document.createElement('option');
        optCat.value = cat.nome + '||';
        optCat.textContent = `${cat.icon} ${cat.nome} (Categoria)`;
        select.appendChild(optCat);
        cat.habilidades.forEach(hab => {
          const opt = document.createElement('option');
          opt.value = cat.nome + '||' + hab;
          opt.textContent = `${cat.icon} ${cat.nome} - ${hab}`;
          select.appendChild(opt);
        });
      });
    }

    // Modal: abrir/fechar
    const modal = document.getElementById('modalRolarDados');
    document.getElementById('rolarDadosBtn').onclick = () => {
      preencherSelectPericia();
      document.getElementById('divHabilidadeInterna').style.display = 'none';
      document.getElementById('resultadoRolagem').textContent = '';
      modal.classList.remove('hidden');
    };
    document.getElementById('fecharModalRolar').onclick = () => {
      modal.classList.add('hidden');
    };

    // Modal: sele√ß√£o de per√≠cia/habilidade
    document.getElementById('selectPericia').onchange = function() {
      // Para este sistema, toda per√≠cia j√° √© "interna" (n√£o h√° subn√≠veis), mas se quiser expandir, adapte aqui
      document.getElementById('divHabilidadeInterna').style.display = 'none';
    };

    // Modal: rolar dados
    document.getElementById('btnRolar').onclick = function() {
      const val = document.getElementById('selectPericia').value;
      if (!val) {
        document.getElementById('resultadoRolagem').textContent = 'Selecione uma per√≠cia.';
        return;
      }
      const [catNome, habNome] = val.split('||');
      let nivel = 0;
      let isCategoria = !habNome;
      let explicacao = '';
      let dados = [];
      let resultado = 0;
      if (isCategoria) {
        // Rolar pela categoria principal
        // Busca todos os n√≠veis das per√≠cias dessa categoria
        let temIntermediario = false;
        let contadorPericiasTreinadas = 0;
        let todasPericiasTreinadas = true;
        const cat = pericias.find(c => c.nome === catNome);
        
        if (cat) {
          cat.habilidades.forEach(hab => {
            const cbs = document.querySelectorAll(`input[data-pericia='${hab}']`);
            let nivelHab = 0;
            cbs.forEach(cb => { 
              if (cb.checked) nivelHab = Math.max(nivelHab, parseInt(cb.dataset.nivel)); 
            });
            if (nivelHab >= 2) temIntermediario = true;
            if (nivelHab >= 1) contadorPericiasTreinadas++;
            else todasPericiasTreinadas = false; // Se alguma per√≠cia n√£o estiver treinada, marca como falso
          });
        }
        
        // Verifica se h√° b√¥nus de dado (todas as per√≠cias treinadas)
        let temDadoBonus = todasPericiasTreinadas && cat && cat.habilidades.length >= 4;
        let bonusDado = temDadoBonus ? 1 : 0;
        
        // Nova regra ajustada:
        // Se tiver pelo menos uma intermedi√°ria/mestre E 2+ per√≠cias treinadas total, fica com 2d10 (melhor)
        if (temIntermediario && contadorPericiasTreinadas >= 2) {
          dados = [rolarD10(), rolarD10()];
          resultado = Math.max(...dados);
          let textoBonus = '';
          
          if (temDadoBonus) {
            let dadoBonus = rolarD10();
            dados.push(dadoBonus);
            resultado += bonusDado;
            textoBonus = ` + B√¥nus de 1 por ter todas as per√≠cias treinadas (${dadoBonus})`;
          }
          
          explicacao = `Categoria: 2d10 (melhor resultado, pois h√° pelo menos uma per√≠cia intermedi√°ria/mestre e 2+ per√≠cias treinadas)${textoBonus}`;
        } 
        // Se tiver pelo menos uma intermedi√°ria/mestre, mesmo que seja s√≥ 1 per√≠cia treinada, fica com 1d10
        else if (temIntermediario) {
          dados = [rolarD10()];
          resultado = dados[0];
          
          if (temDadoBonus) {
            let dadoBonus = rolarD10();
            dados.push(dadoBonus);
            resultado += bonusDado;
            explicacao = `Categoria: 1d10 (h√° uma per√≠cia de n√≠vel intermedi√°rio/mestre) + B√¥nus de 1 por ter todas as per√≠cias treinadas (${dadoBonus})`;
          } else {
            explicacao = 'Categoria: 1d10 (h√° uma per√≠cia de n√≠vel intermedi√°rio/mestre)';
          }
        }
        // Se tiver 2+ per√≠cias treinadas (mesmo que nenhuma intermedi√°ria), fica com 1d10
        else if (contadorPericiasTreinadas >= 2) {
          dados = [rolarD10()];
          resultado = dados[0];
          
          if (temDadoBonus) {
            let dadoBonus = rolarD10();
            dados.push(dadoBonus);
            resultado += bonusDado;
            explicacao = `Categoria: 1d10 (h√° pelo menos 2 per√≠cias treinadas) + B√¥nus de 1 por ter todas as per√≠cias treinadas (${dadoBonus})`;
          } else {
            explicacao = 'Categoria: 1d10 (h√° pelo menos 2 per√≠cias treinadas)';
          }
        }
        // Se tiver 0 per√≠cias ou apenas 1 per√≠cia treinada (n√≠vel 1), fica com 2d10 (pior)
        else {
          dados = [rolarD10(), rolarD10()];
          resultado = Math.min(...dados);
          
          if (temDadoBonus) {
            let dadoBonus = rolarD10();
            dados.push(dadoBonus);
            resultado += bonusDado;
            explicacao = `Categoria: 2d10 (pior resultado, pois h√° menos de 2 per√≠cias treinadas e nenhuma intermedi√°ria/mestre) + B√¥nus de 1 por ter todas as per√≠cias treinadas (${dadoBonus})`;
          } else {
            explicacao = 'Categoria: 2d10 (pior resultado, pois h√° menos de 2 per√≠cias treinadas e nenhuma intermedi√°ria/mestre)';
          }
        }
        document.getElementById('resultadoRolagem').innerHTML =
          `<div class='mb-2'><b>${catNome}</b> (Categoria)</div>`+
          `<div class='mb-2'>${explicacao}</div>`+
          `<div class='mb-2'>Rolagem: <span class='font-mono text-xl'>${dados.join(' , ')}</span></div>`+
          `<div class='mb-2'>Resultado escolhido: <span class='font-bold text-2xl text-blue-700'>${resultado}</span></div>`;
        return;
      }
      // Per√≠cia individual (como antes)
      const cbs = document.querySelectorAll(`input[data-pericia='${habNome}']`);
      cbs.forEach(cb => { if (cb.checked) nivel = Math.max(nivel, parseInt(cb.dataset.nivel)); });
      if (nivel === 0) {
        dados = [rolarD10(), rolarD10()];
        resultado = Math.min(...dados);
        explicacao = 'N√£o treinado: 2d10 (pior resultado)';
      } else if (nivel === 1) {
        dados = [rolarD10()];
        resultado = dados[0];
        explicacao = 'Treinado (N√≠vel 1): 1d10';
      } else {
        dados = [rolarD10(), rolarD10()];
        resultado = Math.max(...dados);
        explicacao = 'Avan√ßado/Mestre (N√≠vel 2-3): 2d10 (melhor resultado)';
      }
      document.getElementById('resultadoRolagem').innerHTML =
        `<div class='mb-2'>${catNome} - <b>${habNome}</b></div>`+
        `<div class='mb-2'>${explicacao}</div>`+
        `<div class='mb-2'>Rolagem: <span class='font-mono text-xl'>${dados.join(' , ')}</span></div>`+
        `<div class='mb-2'>Resultado escolhido: <span class='font-bold text-2xl text-blue-700'>${resultado}</span></div>`;
    };
  </script>
</body>
</html>
