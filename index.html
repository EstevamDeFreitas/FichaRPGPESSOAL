<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de RPG</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input:focus {
      outline: none !important;
      box-shadow: none !important;
      border-top: 0 !important;
      border-left: 0 !important;
      border-right: 0 !important;
      border-radius: 0 !important;
    }
    textarea {
      border: 2px solid #d1d5db; /* gray-300 */
      border-radius: 0.5rem;
      background: #fff;
      transition: border-color 0.2s;
      resize: none;
    }
    textarea:focus {
      border-color: #3b82f6 !important; /* blue-500 */
      outline: none !important;
      box-shadow: none !important;
    }
    
    .janela-arrastavel {
      transition: box-shadow 0.2s ease;
    }
    
    .janela-arrastavel:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .cabecalho-arrastavel {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-bottom: 1px solid #d1d5db;
    }
    
    /* Estilos para slots de equipamentos */
    .equipment-slot {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    
    .equipment-slot.small {
      min-height: 60px;
      padding: 0.5rem;
    }
    
    .equipment-slot:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }
    
    .equipment-slot.has-item {
      border-style: solid;
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .equipment-slot.drag-over {
      border-color: #f59e0b;
      background: #fffbeb;
      transform: scale(1.05);
    }
    
    .slot-icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }
    
    .equipment-slot.small .slot-icon {
      font-size: 1.2rem;
    }
    
    .slot-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6b7280;
    }
    
    .equipped-item {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f0fdf4;
      border-radius: 0.375rem;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .equipped-item-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: #059669;
      text-align: center;
      line-height: 1.2;
    }
    
    /* Estilos para a tabela de invent√°rio */
    .inventory-row {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .inventory-row:hover {
      background: #f9fafb;
    }
    
    .inventory-row.equipped {
      background: #f0fdf4;
      color: #059669;
    }
    
    .item-draggable {
      cursor: grab;
    }
    
    .item-draggable:active {
      cursor: grabbing;
    }
    
    /* Estilos para o gerenciador de conte√∫do */
    .item-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.75rem;
      cursor: grab;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .item-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    
    .item-card:active {
      cursor: grabbing;
    }
    
    .item-card.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    
    .item-card-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }
    
    .item-card-type {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
    .item-card-description {
      font-size: 0.75rem;
      color: #4b5563;
      line-height: 1.3;
      margin-bottom: 0.5rem;
    }
    
    .item-card-actions {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }
    
    .raridade-comum { border-left: 4px solid #6b7280; }
    .raridade-incomum { border-left: 4px solid #10b981; }
    .raridade-raro { border-left: 4px solid #3b82f6; }
    .raridade-epico { border-left: 4px solid #8b5cf6; }
    .raridade-lendario { border-left: 4px solid #f59e0b; }
    
    .cabecalho-arrastavel:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    }
    
    /* For√ßar exibi√ß√£o do modal */
    .modal-show {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-md">
    <h1 class="text-2xl font-bold mb-4 text-center">üìú Ficha de RPG</h1>

    <!-- Dados b√°sicos -->
    <div class="mb-6">
      <div class="flex gap-6 items-start">
        <!-- Imagem do personagem -->
        <div class="flex flex-col items-center w-40 shrink-0">
          <label for="imagemPersonagem" class="block font-semibold mb-2">Imagem</label>
          <div class="border-2 border-dashed border-gray-300 rounded-full w-32 h-32 flex items-center justify-center overflow-hidden bg-gray-50">
            <img id="previewImagem" class="hidden object-cover w-32 h-32" alt="Preview">
          </div>
          <input type="file" id="imagemPersonagem" name="imagemPersonagem" accept="image/*" class="hidden">
          <button type="button" onclick="document.getElementById('imagemPersonagem').click()" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs">Escolher Imagem</button>
          <button id="removerImagem" type="button" onclick="removerImagem()" class="mt-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs hidden">Remover</button>
        </div>
        <!-- Inputs principais -->
        <div class="flex-1 grid grid-cols-4 gap-4">
          <div class="col-span-3">
            <label for="nome" class="block font-semibold">Nome</label>
            <input id="nome" name="nome" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm mb-2 bg-transparent">
          </div>
          <div class="col-span-1">
            <label for="apelido" class="block font-semibold">Apelido</label>
            <input id="apelido" name="apelido" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm mb-2 bg-transparent">
          </div>
          <div class="col-span-2">
            <label for="vocacao" class="block font-semibold">Voca√ß√£o</label>
            <input id="vocacao" name="vocacao" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div class="col-span-2">
            <label for="especie" class="block font-semibold">Esp√©cie</label>
            <input id="especie" name="especie" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="idade" class="block font-semibold">Idade</label>
            <input id="idade" name="idade" type="number" min="0" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="altura" class="block font-semibold">Altura</label>
            <input id="altura" name="altura" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="genero" class="block font-semibold">G√™nero</label>
            <input id="genero" name="genero" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="alinhamento" class="block font-semibold">Alinhamento</label>
            <input id="alinhamento" name="alinhamento" type="text" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          
          <div>
            <!-- Personalidade removida daqui, agora est√° em Backstory -->
          </div>
          <div>
            <label for="vidaAtual" class="block font-semibold">Vida Atual</label>
            <input id="vidaAtual" name="vidaAtual" type="number" min="0" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="vidaMaxima" class="block font-semibold">Vida M√°xima</label>
            <input id="vidaMaxima" name="vidaMaxima" type="number" min="0" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
          <div>
            <label for="drive" class="block font-semibold">Drive</label>
            <input id="drive" name="drive" type="number" min="0" class="w-full border-0 border-b-2 border-gray-300 focus:border-blue-500 focus:ring-0 rounded-none p-1.5 text-sm bg-transparent">
          </div>
        </div>
      </div>
      <br>
      <div class="border-2 border-gray-300 rounded-xl p-4 bg-gray-50 ">
          <h2 class="text-xl font-bold mb-2">üìù Backstory</h2>
          <div class="mb-4">
            <label for="personalidade" class="block font-semibold mb-1">Personalidade</label>
            <textarea id="personalidade" name="personalidade" rows="2" class="w-full p-2 text-sm"></textarea>
          </div>
            <div class="mb-4">
              <label for="historia" class="block font-semibold mb-1">Hist√≥ria</label>
              <textarea id="historia" name="historia" rows="4" class="w-full p-2 text-sm"></textarea>
            </div>
            <div class="mb-4">
              <label for="vinculos" class="block font-semibold mb-1">V√≠nculos</label>
              <textarea id="vinculos" name="vinculos" rows="2" class="w-full p-2 text-sm"></textarea>
            </div>
            <div>
              <label for="observacoes" class="block font-semibold mb-1">Observa√ß√µes</label>
              <textarea id="observacoes" name="observacoes" rows="2" class="w-full p-2 text-sm"></textarea>
            </div>
        </div>
    <!-- Per√≠cias -->
    <div class="mt-8 flex gap-4">
      <div class="flex flex-col gap-6 w-1/2">
        <div class="border-2 border-gray-300 rounded-xl p-4 bg-gray-50 max-w-xl">
          <h2 class="text-xl font-bold mb-2">üé≤ Per√≠cias</h2>
          <div id="periciasContainer" class="space-y-6"></div>
        </div>
      </div>
      <div class="flex flex-col gap-6 w-1/2">
        <div class="border-2 border-gray-300 rounded-xl p-4 bg-gray-50 max-w-xl">
          <h2 class="text-xl font-bold mb-2 flex items-center justify-between">üèÖ Marcos
            <button id="btnAddMarco" type="button" class="ml-2 bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">Adicionar</button>
          </h2>
          <div id="marcosContainer" class="space-y-4"></div>
        </div>
        <div class="border-2 border-gray-300 rounded-xl p-4 bg-gray-50 max-w-xl">
          <h2 class="text-xl font-bold mb-2 flex items-center justify-between">‚ú® Habilidades
            <button id="btnAddHabilidade" type="button" class="ml-2 bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">Adicionar</button>
          </h2>
          <div id="habilidadesContainer" class="space-y-4"></div>
  </div>
<script>
  // --- HABILIDADES ---
  let habilidades = [];

  function renderHabilidades() {
    const container = document.getElementById('habilidadesContainer');
    container.innerHTML = '';
    if (!habilidades.length) {
      container.innerHTML = '<div class="text-gray-400 text-sm">Nenhuma habilidade cadastrada.</div>';
      return;
    }
    habilidades.forEach((hab, idx) => {
      const div = document.createElement('div');
      div.className = 'border rounded-lg p-3 bg-white flex flex-col gap-2 relative';
      div.innerHTML = `
        <button type="button" class="absolute top-2 right-2 text-red-500 hover:text-red-700" title="Remover" onclick="removerHabilidade(${idx})">&times;</button>
        <label class="font-semibold text-xs">Nome</label>
        <input type="text" class="border-b-2 border-gray-200 focus:border-blue-500 outline-none text-sm mb-1 bg-transparent" value="${hab.nome || ''}" onchange="atualizarHabilidade(${idx}, 'nome', this.value)">
        <label class="font-semibold text-xs">Descri√ß√£o</label>
        <textarea rows="2" class="border rounded p-1 text-xs mb-1" onchange="atualizarHabilidade(${idx}, 'descricao', this.value)">${hab.descricao || ''}</textarea>
        <label class="font-semibold text-xs">Jogabilidade</label>
        <textarea rows="2" class="border rounded p-1 text-xs mb-1" onchange="atualizarHabilidade(${idx}, 'jogabilidade', this.value)">${hab.jogabilidade || ''}</textarea>
      `;
      container.appendChild(div);
    });
  }

  function atualizarHabilidade(idx, campo, valor) {
    habilidades[idx][campo] = valor;
    renderHabilidades();
  }

  function removerHabilidade(idx) {
    habilidades.splice(idx, 1);
    renderHabilidades();
  }

  // (btnAddHabilidade movido para DOMContentLoaded)

  renderHabilidades();
</script>

    <!-- Bot√µes -->
    <!-- Bot√µes flutuantes -->
    <div class="fixed right-0 top-1/2 z-50 flex flex-col gap-3 items-end" style="transform: translateY(-60%);">
      <button id="rolarDadosBtn" title="Rolar Dados" class="bg-blue-600 hover:bg-blue-700 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-blue-800" style="z-index:51;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-7">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061A1.125 1.125 0 0 1 3 16.811V8.69ZM12.75 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061a1.125 1.125 0 0 1-1.683-.977V8.69Z" />
        </svg>
      </button>
      <button id="inventarioBtn" title="Invent√°rio" class="bg-green-600 hover:bg-green-700 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-green-800" style="z-index:51;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
        </svg>
      </button>
      <button id="gerenciadorBtn" title="Gerenciador de Conte√∫do" class="bg-orange-600 hover:bg-orange-700 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-orange-800" style="z-index:51;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.563c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375" />
        </svg>
      </button>
      <button onclick="limparFicha()" title="Limpar Ficha" class="bg-red-600 hover:bg-red-700 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-red-800" style="z-index:51;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-7">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <button onclick="exportarFicha()" title="Exportar Ficha" class="bg-purple-600 hover:bg-purple-700 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-purple-800" style="z-index:51;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
        </svg>
      </button>
      <input type="file" id="importarInput" name="importarInput" accept=".json" class="hidden" onchange="importarFicha(event)">
      <button onclick="document.getElementById('importarInput').click()" title="Importar Ficha" class="bg-yellow-500 hover:bg-yellow-600 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-yellow-800" style="z-index:51;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
        </svg>
      </button>
    </div>

    <!-- Modal de rolagem de dados -->
    <div id="modalRolarDados" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
        <button id="fecharModalRolar" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span>üé≤</span> Rolar Dados de Per√≠cia</h2>
        <div class="mb-4">
          <label for="selectPericia" class="block font-semibold mb-1">Per√≠cia</label>
          <select id="selectPericia" name="selectPericia" class="w-full border rounded p-1.5 text-sm">
            <option value="">Selecione...</option>
          </select>
        </div>
        <div class="mb-4" id="divHabilidadeInterna" style="display:none;">
          <label for="selectHabilidadeInterna" class="block font-semibold mb-1">Habilidade</label>
          <select id="selectHabilidadeInterna" name="selectHabilidadeInterna" class="w-full border rounded p-1.5 text-sm"></select>
        </div>
        <button id="btnRolar" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl w-full font-bold">Rolar Dados</button>
        <div id="resultadoRolagem" class="mt-4 text-center text-lg font-semibold"></div>
      </div>
    </div>

    <!-- Modal do Invent√°rio -->
    <!-- Janela Flutuante do Invent√°rio -->
    <div id="modalInventario" class="fixed bg-white rounded-2xl shadow-2xl p-0 w-full max-w-6xl hidden" style="top: 10%; left: 10%; z-index: 100; border: 2px solid #e5e7eb; min-width: 900px; min-height: 600px;">
      <button id="fecharModalInventario" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl z-10">&times;</button>
      <div id="cabecalhoInventario" class="cabecalho-arrastavel p-3 cursor-move select-none border-b">
        <h2 class="text-xl font-bold flex items-center gap-2 justify-between">
          <span>üéí Invent√°rio & Equipamentos</span>
        </h2>
      </div>
      <div class="p-4 flex gap-4 h-[calc(80vh-64px)] overflow-y-auto pt-1">
          <!-- Slots de Equipamentos (Esquerda) -->
          <div class="w-80 bg-gray-50 rounded-lg p-2">
            <h3 class="font-bold text-lg mb-4 text-center">‚öîÔ∏è Equipamentos</h3>
            
            <div class="grid grid-cols-3 gap-3 mb-4">
              <!-- Linha 1: Capacete -->
              <div class="col-start-2">
                <div id="slot-capacete" class="equipment-slot" data-slot="cabeca">
                  <div class="slot-icon">ü™ñ</div>
                  <div class="slot-label">Capacete</div>
                </div>
              </div>
              
              <!-- Linha 2: Armadura -->
              <div class="col-start-2">
                <div id="slot-armadura" class="equipment-slot" data-slot="torso">
                  <div class="slot-icon">üõ°Ô∏è</div>
                  <div class="slot-label">Armadura</div>
                </div>
              </div>
              
              <!-- Linha 3: Luvas -->
              <div class="col-start-2">
                <div id="slot-luvas" class="equipment-slot" data-slot="luvas">
                  <div class="slot-icon">üß§</div>
                  <div class="slot-label">Luvas</div>
                </div>
              </div>
              
              <!-- Linha 4: Botas -->
              <div class="col-start-2">
                <div id="slot-botas" class="equipment-slot" data-slot="pes">
                  <div class="slot-icon">ü•æ</div>
                  <div class="slot-label">Botas</div>
                </div>
              </div>
            </div>
            
            <!-- Armas -->
            <div class="mt-4">
              <h4 class="font-semibold mb-2 text-center">‚öîÔ∏è Armas</h4>
              <div class="grid grid-cols-2 gap-2">
                <div id="slot-arma-principal" class="equipment-slot small" data-slot="mao_principal">
                  <div class="slot-icon">‚öîÔ∏è</div>
                  <div class="slot-label">Principal</div>
                </div>
                <div id="slot-arma-secundaria" class="equipment-slot small" data-slot="mao_secundaria">
                  <div class="slot-icon">üó°Ô∏è</div>
                  <div class="slot-label">Secund√°ria</div>
                </div>
              </div>
            </div>
            
            <!-- Acess√≥rios -->
            <div class="mt-4">
              <h4 class="font-semibold mb-2 text-center">üíç Acess√≥rios</h4>
              <div class="grid grid-cols-2 gap-2">
                <div id="slot-anel1" class="equipment-slot small" data-slot="anel">
                  <div class="slot-icon">üíç</div>
                  <div class="slot-label">Anel 1</div>
                </div>
                <div id="slot-anel2" class="equipment-slot small" data-slot="anel">
                  <div class="slot-icon">üíç</div>
                  <div class="slot-label">Anel 2</div>
                </div>
                <div id="slot-colar" class="equipment-slot small col-span-2" data-slot="colar">
                  <div class="slot-icon">üìø</div>
                  <div class="slot-label">Colar</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Lista de Invent√°rio (Direita) -->
          <div class="flex-1">
            <h3 class="font-bold text-lg mb-4">üì¶ Itens</h3>
            
            <!-- Filtros -->
            <div class="mb-4 flex gap-2">
              <select id="filtroTipo" class="border rounded px-3 py-1 text-sm">
                <option value="">Todos os tipos</option>
                <option value="arma">Armas</option>
                <option value="capacete">Capacetes</option>
                <option value="armadura">Armaduras</option>
                <option value="luvas">Luvas</option>
                <option value="botas">Botas</option>
                <option value="anel">An√©is</option>
                <option value="colar">Colares/Amuletos</option>
                <option value="consumivel">Consum√≠veis</option>
                <option value="ferramenta">Ferramentas</option>
                <option value="outro">Outros</option>
              </select>
              <input type="text" id="buscaItem" placeholder="Buscar item..." class="border rounded px-3 py-1 text-sm flex-1">
            </div>
            
            <!-- Tabela de Invent√°rio -->
            <div class="overflow-x-auto">
              <table class="w-full text-sm border-collapse">
                <thead>
                  <tr class="bg-gray-100 border-b">
                    <th class="text-left p-2 w-8">#</th>
                    <th class="text-left p-2">Nome</th>
                    <th class="text-left p-2 w-20">Tipo</th>
                    <th class="text-left p-2 w-16">Peso</th>
                    <th class="text-left p-2 w-20">Qtd</th>
                    <th class="text-left p-2 w-20">Status</th>
                    <th class="text-left p-2 w-20">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="inventarioTabela">
                  <!-- Itens ser√£o renderizados aqui -->
                </tbody>
              </table>
            </div>
            
            <!-- Resumo do Invent√°rio -->
            <div id="resumoInventario" class="mt-3 p-2 bg-gray-50 rounded text-sm text-gray-600 border-t">
              <!-- Ser√° preenchido dinamicamente -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Janela de Item (flutuante) -->
    <div id="itemWindow" class="fixed bg-white rounded-2xl shadow-2xl w-96 overflow-hidden cursor-move janela-arrastavel hidden" style="position: fixed; top: 20%; right: 20px; z-index: 100; border: 2px solid #e5e7eb;">
      <div id="cabecalhoItem" class="cabecalho-arrastavel p-3 cursor-move select-none border-b">
        <h2 class="text-lg font-bold" id="tituloModalItem">üì¶ Novo Item</h2>
        <button id="fecharModalItem" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl cursor-pointer">&times;</button>
      </div>
      
      <div class="p-4 max-h-96 overflow-y-auto">
        <div class="space-y-3">
        <div>
          <label for="itemNome" class="block font-semibold mb-1 text-sm">Nome</label>
          <input id="itemNome" type="text" class="w-full border rounded p-2 text-sm">
        </div>
        
        <div>
          <label for="itemDescricao" class="block font-semibold mb-1 text-sm">Descri√ß√£o</label>
          <textarea id="itemDescricao" rows="2" class="w-full border rounded p-2 text-sm"></textarea>
        </div>
        
        <div>
          <label for="itemTipoDano" class="block font-semibold mb-1 text-sm">Tipos de Dano</label>
          <input id="itemTipoDano" type="text" placeholder="Ex: +3 de dano √°cido" class="w-full border rounded p-2 text-sm">
        </div>
        
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label for="itemRecuperaVida" class="block font-semibold mb-1 text-xs">Recupera Vida</label>
            <input id="itemRecuperaVida" type="number" min="0" class="w-full border rounded p-1 text-sm">
          </div>
          
          <div>
            <label for="itemPeso" class="block font-semibold mb-1 text-xs">Peso</label>
            <input id="itemPeso" type="number" step="0.1" min="0" class="w-full border rounded p-1 text-sm">
          </div>
        </div>
        
        <div>
          <label for="itemRecupera" class="block font-semibold mb-1 text-sm">Recupera</label>
          <input id="itemRecupera" type="text" placeholder="Ex: Mana, Energia" class="w-full border rounded p-2 text-sm">
        </div>
        
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label for="itemConsumivel" class="block font-semibold mb-1 text-xs">Consum√≠vel</label>
            <select id="itemConsumivel" class="w-full border rounded p-1 text-sm">
              <option value="false">N√£o</option>
              <option value="true">Sim</option>
            </select>
          </div>
          
          <div>
            <label for="itemRaridade" class="block font-semibold mb-1 text-xs">Raridade</label>
            <select id="itemRaridade" class="w-full border rounded p-1 text-sm">
              <option value="comum">Comum</option>
              <option value="incomum">Incomum</option>
              <option value="raro">Raro</option>
              <option value="epico">√âpico</option>
              <option value="lendario">Lend√°rio</option>
            </select>
          </div>
        </div>
        
        <div class="grid grid-cols-1 gap-2">
          <div>
            <label for="itemTipo" class="block font-semibold mb-1 text-xs">Tipo</label>
            <select id="itemTipo" class="w-full border rounded p-1 text-sm">
              <option value="">Selecione...</option>
              <option value="arma">Arma</option>
              <option value="capacete">Capacete</option>
              <option value="armadura">Armadura de Torso</option>
              <option value="luvas">Luvas</option>
              <option value="botas">Botas</option>
              <option value="anel">Anel</option>
              <option value="colar">Colar/Amuleto</option>
              <option value="consumivel">Consum√≠vel</option>
              <option value="ferramenta">Ferramenta</option>
              <option value="outro">Outro</option>
            </select>
          </div>
        </div>
        
        <div>
          <label for="itemPropriedades" class="block font-semibold mb-1 text-sm">Propriedades</label>
          <textarea id="itemPropriedades" rows="2" class="w-full border rounded p-2 text-sm"></textarea>
        </div>
        
        <div>
          <label for="itemEquipadoEm" class="block font-semibold mb-1 text-sm">Equipado em</label>
          <select id="itemEquipadoEm" class="w-full border rounded p-2 text-sm">
            <option value="">N√£o equipado</option>
            <option value="cabeca">Cabe√ßa</option>
            <option value="torso">Torso</option>
            <option value="luvas">Luvas</option>
            <option value="pes">P√©s</option>
            <option value="mao_principal">M√£o Principal</option>
            <option value="mao_secundaria">M√£o Secund√°ria</option>
            <option value="anel">Anel</option>
            <option value="colar">Colar</option>
          </select>
        </div>
      </div>
      
      <div class="flex gap-2 p-4 pt-2 border-t bg-gray-50">
        <button id="salvarItem" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm flex-1">Salvar</button>
        <button id="cancelarItem" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">Cancelar</button>
      </div>
    </div>

    <!-- Input oculto para importar itens -->
    <input type="file" id="importarItensInput" accept=".json" class="hidden">

    <!-- Janela do Gerenciador de Conte√∫do (flutuante) - MOVIDO PARA FORA DO CONTAINER -->
    <div id="modalGerenciador" class="fixed bg-white rounded-2xl shadow-2xl p-0 w-full max-w-5xl hidden" style="top: 5%; left: 5%; z-index: 100; border: 2px solid #e5e7eb; min-width: 800px; min-height: 700px;">
      <button onclick="document.getElementById('modalGerenciador').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl z-10">&times;</button>
      <div id="cabecalhoGerenciador" class="cabecalho-arrastavel p-3 cursor-move select-none border-b">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <span>üóÉÔ∏è Gerenciador de Conte√∫do</span>
        </h2>
      </div>
      
      <div class="p-4 h-[calc(85vh-64px)] overflow-y-auto">
        <!-- Abas -->
        <div class="flex border-b mb-4">
          <button id="abaItens" class="px-4 py-2 border-b-2 border-orange-500 text-orange-600 font-semibold">üì¶ Itens</button>
          <button class="px-4 py-2 text-gray-500 cursor-not-allowed" disabled>üèõÔ∏è Locais (Em breve)</button>
          <button class="px-4 py-2 text-gray-500 cursor-not-allowed" disabled>üë• NPCs (Em breve)</button>
        </div>
        
        <!-- Conte√∫do da aba Itens -->
        <div id="conteudoItens">
          <!-- Barra de ferramentas -->
          <div class="flex gap-3 mb-4 flex-wrap">
            <button id="criarItemGerenciador" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
              <span>‚ûï</span> Criar Item
            </button>
            <button id="importarItensBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
              <span>üì•</span> Importar Lista
            </button>
            <button id="exportarItensBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
              <span>üì§</span> Exportar Lista
            </button>
            <div class="flex-1"></div>
            <input type="text" id="buscarItensGerenciador" placeholder="Buscar itens..." class="border rounded px-3 py-2 text-sm w-64">
          </div>
          
          <!-- Filtros -->
          <div class="flex gap-3 mb-4">
            <select id="filtroTipoGerenciador" class="border rounded px-3 py-2 text-sm">
              <option value="">Todos os tipos</option>
              <option value="arma">Armas</option>
              <option value="capacete">Capacetes</option>
              <option value="armadura">Armaduras</option>
              <option value="luvas">Luvas</option>
              <option value="botas">Botas</option>
              <option value="anel">An√©is</option>
              <option value="colar">Colares/Amuletos</option>
              <option value="consumivel">Consum√≠veis</option>
              <option value="ferramenta">Ferramentas</option>
              <option value="outro">Outros</option>
            </select>
            <select id="filtroRaridadeGerenciador" class="border rounded px-3 py-2 text-sm">
              <option value="">Todas as raridades</option>
              <option value="comum">Comum</option>
              <option value="incomum">Incomum</option>
              <option value="raro">Raro</option>
              <option value="epico">√âpico</option>
              <option value="lendario">Lend√°rio</option>
            </select>
          </div>
          
          <!-- Lista de Itens do Gerenciador -->
          <div class="border rounded-lg bg-gray-50 p-4 h-96 overflow-y-auto">
            <div id="listaItensGerenciador" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <!-- Itens do gerenciador ser√£o renderizados aqui -->
            </div>
            <div id="nenhumItemGerenciador" class="text-center text-gray-500 py-8 hidden">
              Nenhum item encontrado. Crie ou importe itens para come√ßar.
            </div>
          </div>
        </div>
      </div>
    </div>

  <script>
    // --- INVENT√ÅRIO ---
    // === SISTEMA DE IDENTIFICA√á√ÉO √öNICA (GUID) ===
    function gerarGUID() {
      return 'item_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 16);
    }

    // Fun√ß√£o para gerar GUID √∫nico no contexto do gerenciador
    function gerarGUIDUnicoGerenciador() {
      let novoId;
      let tentativas = 0;
      do {
        novoId = gerarGUID();
        tentativas++;
        if (tentativas > 100) {
          // Fallback para evitar loop infinito
          novoId = gerarGUID() + '_' + tentativas;
          break;
        }
      } while (itensGerenciador.some(item => item.id === novoId));
      
      return novoId;
    }

    // Fun√ß√£o para migrar dados antigos do sistema de sincroniza√ß√£o
    function migrarDadosInventario() {
      let houveMigracao = false;
      
      inventario.forEach(item => {
        // Migrar gerenciadorId para sourceId se necess√°rio
        if (item.gerenciadorId && !item.sourceId) {
          item.sourceId = item.gerenciadorId;
          delete item.gerenciadorId;
          houveMigracao = true;
        }
        
        // Garantir que todos os itens tenham metadados b√°sicos
        if (!item.criadoEm) {
          item.criadoEm = new Date().toISOString();
          houveMigracao = true;
        }
        
        if (!item.origem && item.sourceId) {
          item.origem = 'gerenciador';
          houveMigracao = true;
        }
        
        // Adicionar quantidade padr√£o se n√£o existir
        if (!item.quantidade || item.quantidade < 1) {
          item.quantidade = 1;
          houveMigracao = true;
        }
      });
      
      // Salvar se houve migra√ß√£o
      if (houveMigracao) {
        localStorage.setItem('inventario', JSON.stringify(inventario));
        console.log('üîÑ Dados do invent√°rio migrados para o novo sistema');
      }
    }

    // Fun√ß√£o de debug para verificar equipamentos
    function debugEquipamentos() {
      console.group('‚öîÔ∏è Debug - Sistema de Equipamentos');
      
      const itensEquipados = inventario.filter(item => item.equipadoEm);
      console.log('üìã Itens equipados:', itensEquipados.length);
      
      itensEquipados.forEach(item => {
        console.log(`- ${item.nome} ‚Üí ${item.equipadoEm} (ID: ${item.id})`);
      });
      
      // Verificar conflitos nos slots
      const slotsOcupados = {};
      itensEquipados.forEach(item => {
        const slot = item.equipadoEm;
        if (!slotsOcupados[slot]) {
          slotsOcupados[slot] = [];
        }
        slotsOcupados[slot].push(item);
      });
      
      console.log('\nüîç Status dos slots:');
      Object.entries(slotsOcupados).forEach(([slot, itens]) => {
        if (slot === 'anel' && itens.length > 2) {
          console.warn(`‚ö†Ô∏è Slot ${slot}: ${itens.length} itens (m√°ximo 2)`);
        } else if (slot !== 'anel' && itens.length > 1) {
          console.warn(`‚ö†Ô∏è Slot ${slot}: ${itens.length} itens (m√°ximo 1)`);
        } else {
          console.log(`‚úÖ Slot ${slot}: ${itens.length} item(s)`);
        }
      });
      
      console.groupEnd();
    }

    // Fun√ß√£o de debug para verificar sincroniza√ß√£o (pode ser removida em produ√ß√£o)
    function debugSincronizacao() {
      console.group('üîç Debug - Estado da Sincroniza√ß√£o');
      console.log('üì¶ Itens no Gerenciador:', itensGerenciador.length);
      console.log('üéí Itens no Invent√°rio:', inventario.length);
      
      // Verificar duplicatas no gerenciador
      const idsGerenciador = itensGerenciador.map(item => item.id);
      const duplicatasGerenciador = idsGerenciador.filter((id, index) => idsGerenciador.indexOf(id) !== index);
      if (duplicatasGerenciador.length > 0) {
        console.warn('‚ö†Ô∏è Duplicatas encontradas no gerenciador:', duplicatasGerenciador);
      } else {
        console.log('‚úÖ Nenhuma duplicata no gerenciador');
      }
      
      // Verificar poss√≠veis duplicatas por conte√∫do
      const duplicatasConteudo = [];
      itensGerenciador.forEach((item, index) => {
        const duplicata = itensGerenciador.find((outro, outroIndex) => 
          index !== outroIndex && itemEhDuplicataPorConteudo(item, [outro])
        );
        if (duplicata && !duplicatasConteudo.some(d => d.id === item.id)) {
          duplicatasConteudo.push(item);
        }
      });
      
      if (duplicatasConteudo.length > 0) {
        console.warn('‚ö†Ô∏è Poss√≠veis duplicatas por conte√∫do:', duplicatasConteudo.map(item => `${item.nome} (${item.id})`));
      }
      
      console.log('\nüìã Mapeamento de Sincroniza√ß√£o:');
      itensGerenciador.forEach(itemGer => {
        const estaNoInv = itemEstaNoInventario(itemGer.id);
        const itemInv = encontrarItemNoInventario(itemGer.id);
        console.log(`- ${itemGer.nome} (${itemGer.id}): ${estaNoInv ? '‚úÖ Sincronizado' : '‚ö™ N√£o no invent√°rio'}`);
        if (itemInv) {
          console.log(`  ‚îî‚îÄ Invent√°rio ID: ${itemInv.id}, Source: ${itemInv.sourceId || itemInv.gerenciadorId || 'N/A'}`);
        }
      });
      
      console.log('\nüîó Itens √≥rf√£os no invent√°rio (sem source):');
      const orfaos = inventario.filter(item => !item.sourceId && !item.gerenciadorId);
      orfaos.forEach(item => {
        console.log(`- ${item.nome} (${item.id}): Sem refer√™ncia ao gerenciador`);
      });
      
      console.groupEnd();
    }

    // Fun√ß√£o para verificar se um item √© duplicata por conte√∫do (al√©m do ID)
    function itemEhDuplicataPorConteudo(novoItem, listaExistente) {
      return listaExistente.some(existente => 
        existente.nome === novoItem.nome && 
        existente.tipo === novoItem.tipo &&
        existente.descricao === novoItem.descricao &&
        existente.raridade === novoItem.raridade
      );
    }

    // Fun√ß√£o para verificar se um item do gerenciador est√° no invent√°rio
    function itemEstaNoInventario(itemGerenciadorId) {
      return inventario.some(invItem => 
        invItem.sourceId === itemGerenciadorId || 
        invItem.gerenciadorId === itemGerenciadorId || // Compatibilidade com dados antigos
        invItem.id === itemGerenciadorId
      );
    }

    // Fun√ß√£o para encontrar item no invent√°rio por ID do gerenciador
    function encontrarItemNoInventario(itemGerenciadorId) {
      return inventario.find(invItem => 
        invItem.sourceId === itemGerenciadorId || 
        invItem.gerenciadorId === itemGerenciadorId || // Compatibilidade com dados antigos
        invItem.id === itemGerenciadorId
      );
    }

    let inventario = [];
    let itemEditandoIndex = -1;

    // --- GERENCIADOR DE CONTE√öDO ---
    let itensGerenciador = [];
    let itemEditandoGerenciador = null;

    // Fun√ß√£o para tornar elementos arrast√°veis
    function tornarArrastavel(elementoId, cabecalhoId) {
      const elemento = document.getElementById(elementoId);
      const cabecalho = document.getElementById(cabecalhoId);
      
      if (!elemento || !cabecalho) return;
      
      let isDragging = false;
      let currentX;
      let currentY;
      let initialX;
      let initialY;
      let xOffset = 0;
      let yOffset = 0;

      cabecalho.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);

      function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === cabecalho || cabecalho.contains(e.target)) {
          isDragging = true;
          cabecalho.style.cursor = 'grabbing';
        }
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;

          xOffset = currentX;
          yOffset = currentY;

          elemento.style.transform = `translate(${currentX}px, ${currentY}px)`;
        }
      }

      function dragEnd() {
        if (isDragging) {
          initialX = currentX;
          initialY = currentY;
          isDragging = false;
          cabecalho.style.cursor = 'move';
        }
      }
    }

    // Carregar itens do gerenciador do localStorage
    function carregarItensGerenciador() {
      const itens = localStorage.getItem('itensGerenciador');
      if (itens) {
        try {
          const itensCarregados = JSON.parse(itens);
          itensGerenciador.length = 0; // Limpar array para evitar duplica√ß√£o
          itensGerenciador.push(...itensCarregados); // Adicionar itens carregados
          console.log('üóÉÔ∏è Itens do gerenciador carregados:', itensGerenciador.length, 'itens');
          
          // Limpar duplicatas se existirem
          limparDuplicatasGerenciador();
        } catch (e) {
          console.error('Erro ao carregar itens do gerenciador:', e);
        }
      }
      
      renderItensGerenciador();
    }

    function salvarItensGerenciador() {
      localStorage.setItem('itensGerenciador', JSON.stringify(itensGerenciador));
    }

    // Fun√ß√£o de limpeza para remover duplicatas (caso existam)
    function limparDuplicatasGerenciador() {
      const idsVistos = new Set();
      const itensUnicos = [];
      
      itensGerenciador.forEach(item => {
        if (!idsVistos.has(item.id)) {
          idsVistos.add(item.id);
          itensUnicos.push(item);
        }
      });
      
      if (itensUnicos.length !== itensGerenciador.length) {
        itensGerenciador.length = 0;
        itensGerenciador.push(...itensUnicos);
        salvarItensGerenciador();
        console.log('üßπ Duplicatas por ID removidas do gerenciador');
        return true;
      }
      return false;
    }

    // Fun√ß√£o avan√ßada para remover duplicatas por conte√∫do
    function limparDuplicatasPorConteudo() {
      const itensUnicos = [];
      const removidos = [];
      
      itensGerenciador.forEach(item => {
        const jaDuplicado = itensUnicos.some(unico => itemEhDuplicataPorConteudo(item, [unico]));
        
        if (!jaDuplicado) {
          itensUnicos.push(item);
        } else {
          removidos.push(item);
        }
      });
      
      if (removidos.length > 0) {
        itensGerenciador.length = 0;
        itensGerenciador.push(...itensUnicos);
        salvarItensGerenciador();
        renderItensGerenciador();
        console.log(`üßπ ${removidos.length} duplicatas por conte√∫do removidas:`, removidos.map(item => item.nome));
        return true;
      } else {
        console.log('‚úÖ Nenhuma duplicata por conte√∫do encontrada');
        return false;
      }
    }

    function renderItensGerenciador() {
      const container = document.getElementById('listaItensGerenciador');
      const nenhumItem = document.getElementById('nenhumItemGerenciador');
  // Se o modal ainda n√£o existe no DOM, n√£o h√° nada para renderizar agora
  if (!container || !nenhumItem) return;
      
      // Aplicar filtros
      const filtroTipo = document.getElementById('filtroTipoGerenciador')?.value || '';
  const filtroRaridade = document.getElementById('filtroRaridadeGerenciador')?.value || '';
  const busca = document.getElementById('buscarItensGerenciador')?.value.toLowerCase() || '';
      
      const itensFiltrados = itensGerenciador.filter(item => {
        const matchTipo = !filtroTipo || item.tipo === filtroTipo;
        const matchRaridade = !filtroRaridade || item.raridade === filtroRaridade;
        const matchBusca = !busca || 
          item.nome?.toLowerCase().includes(busca) || 
          item.descricao?.toLowerCase().includes(busca) ||
          item.propriedades?.toLowerCase().includes(busca);
        return matchTipo && matchRaridade && matchBusca;
      });
      
      container.innerHTML = '';
      
      if (itensFiltrados.length === 0) {
        nenhumItem.classList.remove('hidden');
        return;
      }
      
      nenhumItem.classList.add('hidden');
      
      itensFiltrados.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = `item-card raridade-${item.raridade || 'comum'}`;
        card.draggable = true;
        card.dataset.itemId = item.id;
        card.style.cssText = `
          background: white;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 12px;
          cursor: grab;
          transition: all 0.2s ease;
          position: relative;
          border-left: 4px solid ${getRaridadeCor(item.raridade || 'comum')};
        `;
        
        const isNoInventario = itemEstaNoInventario(item.id);
        
        card.innerHTML = `
          <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${item.nome || 'Item sem nome'}</div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">${item.tipo ? item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1) : 'Sem tipo'}</div>
          ${item.descricao ? `<div style="font-size: 12px; color: #4b5563; line-height: 1.3; margin-bottom: 8px;">${item.descricao}</div>` : ''}
          ${item.peso ? `<div style="font-size: 10px; color: #6b7280; margin-bottom: 8px;">Peso: ${item.peso}kg</div>` : ''}
          <div style="display: flex; gap: 4px; margin-top: 8px;">
            <button onclick="editarItemGerenciador('${item.id}')" style="color: #2563eb; background: none; border: none; cursor: pointer; font-size: 12px;" title="Editar">‚úèÔ∏è</button>
            <button onclick="duplicarItemGerenciador('${item.id}')" style="color: #16a34a; background: none; border: none; cursor: pointer; font-size: 12px;" title="Duplicar">üìã</button>
            <button onclick="removerItemGerenciador('${item.id}')" style="color: #dc2626; background: none; border: none; cursor: pointer; font-size: 12px;" title="Remover">üóëÔ∏è</button>
            <div style="flex: 1;"></div>
            ${!isNoInventario ? `<span style="color: #6b7280; font-size: 10px;">Arraste para o invent√°rio</span>` : '<span style="color: #16a34a; font-size: 10px;">‚úì No invent√°rio</span>'}
          </div>
        `;
        
        // Adicionar eventos de drag
        card.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', JSON.stringify({
            source: 'gerenciador',
            itemId: item.id,
            itemData: item // Incluir todos os dados do item
          }));
          card.style.opacity = '0.5';
          card.style.transform = 'rotate(5deg)';
        });
        
        card.addEventListener('dragend', () => {
          card.style.opacity = '1';
          card.style.transform = 'none';
        });
        
        // Hover effects
        card.addEventListener('mouseenter', () => {
          card.style.borderColor = '#3b82f6';
          card.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
          card.style.transform = 'translateY(-1px)';
        });
        
        card.addEventListener('mouseleave', () => {
          card.style.borderColor = '#e5e7eb';
          card.style.boxShadow = 'none';
          card.style.transform = 'none';
        });
        
        container.appendChild(card);
      });
    }

    function criarNovoItemGerenciador() {
      const novoItem = {
        id: gerarGUIDUnicoGerenciador(),
        nome: 'Novo Item',
        descricao: '',
        tipo: '',
        raridade: 'comum',
        tipoDano: '',
        recuperaVida: '',
        recupera: '',
        consumivel: 'false',
        propriedades: '',
        peso: '',
        equipadoEm: ''
      };
      
      itemEditandoGerenciador = novoItem;
      preencherFormularioItem(novoItem);
      document.getElementById('tituloModalItem').textContent = 'üì¶ Novo Item (Gerenciador)';
      
      // Posicionar o modal do item pr√≥ximo ao modal do gerenciador
      const itemWindow = document.getElementById('itemWindow');
      itemWindow.style.top = '10%';
      itemWindow.style.right = '10px';
      itemWindow.style.left = 'auto';
      
      itemWindow.classList.remove('hidden');
      
      // Dar foco no campo nome e selecionar o texto para edi√ß√£o r√°pida
      setTimeout(() => {
        document.getElementById('itemNome').focus();
        document.getElementById('itemNome').select();
      }, 100);
    }

    function editarItemGerenciador(itemId) {
      const item = itensGerenciador.find(i => i.id === itemId);
      if (item) {
        itemEditandoGerenciador = { ...item };
        preencherFormularioItem(item);
        document.getElementById('tituloModalItem').textContent = 'üì¶ Editar Item (Gerenciador)';
        
        // Posicionar o modal do item pr√≥ximo ao modal do gerenciador, mas sem sobrepor
        const itemWindow = document.getElementById('itemWindow');
        itemWindow.style.top = '10%';
        itemWindow.style.right = '10px';
        itemWindow.style.left = 'auto';
        
        itemWindow.classList.remove('hidden');
        
        // Dar foco no campo nome para melhor UX
        setTimeout(() => {
          document.getElementById('itemNome').focus();
          document.getElementById('itemNome').select();
        }, 100);
      }
    }

    function duplicarItemGerenciador(itemId) {
      const item = itensGerenciador.find(i => i.id === itemId);
      if (item) {
        const duplicado = {
          ...item,
          id: gerarGUIDUnicoGerenciador(),
          nome: item.nome + ' (C√≥pia)'
        };
        itensGerenciador.push(duplicado);
        salvarItensGerenciador();
        renderItensGerenciador();
      }
    }

    function removerItemGerenciador(itemId) {
      if (confirm('Tem certeza que deseja remover este item do gerenciador?')) {
        itensGerenciador = itensGerenciador.filter(i => i.id !== itemId);
        
        // Remover do invent√°rio tamb√©m se estiver l√° (usando o sistema de rastreamento)
        inventario = inventario.filter(i => 
          i.sourceId !== itemId && 
          i.gerenciadorId !== itemId && // Compatibilidade com dados antigos
          i.id !== itemId
        );
        
        salvarItensGerenciador();
        localStorage.setItem('inventario', JSON.stringify(inventario));
        renderItensGerenciador();
        renderInventario();
      }
    }

    function getRaridadeCor(raridade) {
      const cores = {
        'comum': '#6b7280',
        'incomum': '#10b981',
        'raro': '#3b82f6',
        'epico': '#8b5cf6',
        'lendario': '#f59e0b'
      };
      return cores[raridade] || cores['comum'];
    }

    function adicionarAoInventario(itemId) {
      const item = itensGerenciador.find(i => i.id === itemId);
      if (item && !inventario.some(invItem => invItem.id === itemId)) {
        inventario.push({ ...item });
        renderInventario();
        renderItensGerenciador();
      }
    }

    function importarListaItens() {
      document.getElementById('importarItensInput').click();
    }

    function exportarListaItens() {
      const blob = new Blob([JSON.stringify(itensGerenciador, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'lista_itens.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function preencherFormularioItem(item) {
      document.getElementById('itemNome').value = item.nome || '';
      document.getElementById('itemDescricao').value = item.descricao || '';
      document.getElementById('itemTipoDano').value = item.tipoDano || '';
      document.getElementById('itemRecuperaVida').value = item.recuperaVida || '';
      document.getElementById('itemRecupera').value = item.recupera || '';
      document.getElementById('itemConsumivel').value = item.consumivel || 'false';
      document.getElementById('itemRaridade').value = item.raridade || 'comum';
      document.getElementById('itemPropriedades').value = item.propriedades || '';
      document.getElementById('itemPeso').value = item.peso || '';
      document.getElementById('itemTipo').value = item.tipo || '';
      document.getElementById('itemEquipadoEm').value = item.equipadoEm || '';
    }

    function renderInventario() {
      renderInventarioTabela();
      renderEquipamentos();
    }

    function renderInventarioTabela() {
      const tbody = document.getElementById('inventarioTabela');
      tbody.innerHTML = '';
      
      if (!inventario.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">Nenhum item no invent√°rio.</td></tr>';
        return;
      }

      // Aplicar filtros
      const filtroTipo = document.getElementById('filtroTipo')?.value || '';
      const busca = document.getElementById('buscaItem')?.value.toLowerCase() || '';
      
      const itensFiltrados = inventario.filter(item => {
        const matchTipo = !filtroTipo || item.tipo === filtroTipo;
        const matchBusca = !busca || item.nome?.toLowerCase().includes(busca) || item.descricao?.toLowerCase().includes(busca);
        return matchTipo && matchBusca;
      });

      itensFiltrados.forEach((item, idx) => {
        const realIdx = inventario.indexOf(item);
        
        // Verificar se o item ainda existe no invent√°rio principal
        if (realIdx === -1) {
          console.warn('Item filtrado n√£o encontrado no invent√°rio principal:', item);
          return; // Pular este item
        }
        
        const tr = document.createElement('tr');
        tr.className = `inventory-row border-b ${item.equipadoEm ? 'equipped' : ''}`;
        tr.draggable = true;
        tr.dataset.itemIndex = realIdx;
        
        const statusText = item.equipadoEm ? 'Equipado' : (item.consumivel === 'true' ? 'Consum√≠vel' : 'Normal');
        const statusColor = item.equipadoEm ? 'text-green-600' : (item.consumivel === 'true' ? 'text-orange-600' : 'text-gray-600');
        
        // Garantir que quantidade seja pelo menos 1
        if (!item.quantidade || item.quantidade < 1) {
          item.quantidade = 1;
        }
        
        tr.innerHTML = `
          <td class="p-2 text-center text-gray-500">${realIdx + 1}</td>
          <td class="p-2">
            <div class="font-medium">${item.nome || 'Item sem nome'}</div>
            ${item.descricao ? `<div class="text-xs text-gray-500 truncate max-w-xs">${item.descricao}</div>` : ''}
          </td>
          <td class="p-2">
            <span class="px-2 py-1 rounded text-xs bg-gray-100">${item.tipo || '-'}</span>
          </td>
          <td class="p-2 text-center">${item.peso ? (item.peso * (item.quantidade || 1)).toFixed(1) + 'kg' : '-'}</td>
          <td class="p-2">
            <div class="flex items-center gap-1">
              <button onclick="alterarQuantidade(${realIdx}, -1)" class="w-6 h-6 flex items-center justify-center text-xs bg-red-100 hover:bg-red-200 text-red-600 rounded" title="Diminuir quantidade">-</button>
              <span class="w-8 text-center text-sm font-medium">${item.quantidade || 1}</span>
              <button onclick="alterarQuantidade(${realIdx}, 1)" class="w-6 h-6 flex items-center justify-center text-xs bg-green-100 hover:bg-green-200 text-green-600 rounded" title="Aumentar quantidade">+</button>
            </div>
          </td>
          <td class="p-2">
            <span class="text-xs ${statusColor}">${statusText}</span>
          </td>
          <td class="p-2">
            <div class="flex gap-1">
              <button onclick="editarItem(${realIdx})" class="text-blue-600 hover:text-blue-800" title="Editar">‚úèÔ∏è</button>
              <button onclick="removerItem(${realIdx})" class="text-red-600 hover:text-red-800" title="Remover">üóëÔ∏è</button>
              ${!item.equipadoEm ? `<button onclick="mostrarMenuEquipar(${realIdx}, event)" class="text-green-600 hover:text-green-800" title="Equipar">‚öîÔ∏è</button>` : `<button onclick="desequiparItem(${realIdx})" class="text-orange-600 hover:text-orange-800" title="Desequipar">üì§</button>`}
            </div>
          </td>
        `;
        
        // Adicionar eventos de drag
        tr.addEventListener('dragstart', (e) => {
          // Verificar se realIdx √© v√°lido
          if (realIdx >= 0 && realIdx < inventario.length) {
            const dragData = {
              source: 'inventario',
              itemIndex: realIdx,
              itemId: item.id,
              itemData: item
            };
            e.dataTransfer.setData('text/plain', JSON.stringify(dragData));
            tr.style.opacity = '0.5';
          } else {
            e.preventDefault();
            console.error('√çndice de item inv√°lido para drag:', realIdx);
          }
        });
        
        tr.addEventListener('dragend', () => {
          tr.style.opacity = '1';
        });
        
        tbody.appendChild(tr);
      });
      
      // Atualizar resumo do invent√°rio
      atualizarResumoInventario();
    }

    function atualizarResumoInventario() {
      const resumo = document.getElementById('resumoInventario');
      if (!resumo) return;
      
      const totalItens = inventario.length;
      const totalQuantidade = inventario.reduce((acc, item) => acc + (item.quantidade || 1), 0);
      const pesoTotal = inventario.reduce((acc, item) => {
        const peso = parseFloat(item.peso) || 0;
        const quantidade = item.quantidade || 1;
        return acc + (peso * quantidade);
      }, 0);
      
      const itensEquipados = inventario.filter(item => item.equipadoEm).length;
      const consumiveis = inventario.filter(item => item.consumivel === 'true').length;
      
      resumo.innerHTML = `
        <div class="flex justify-between items-center flex-wrap gap-2">
          <div class="flex gap-4 text-xs">
            <span><strong>${totalItens}</strong> tipos de item</span>
            <span><strong>${totalQuantidade}</strong> unidades totais</span>
            <span><strong>${pesoTotal.toFixed(1)}kg</strong> de peso total</span>
          </div>
          <div class="flex gap-4 text-xs">
            <span class="text-green-600"><strong>${itensEquipados}</strong> equipados</span>
            <span class="text-orange-600"><strong>${consumiveis}</strong> consum√≠veis</span>
          </div>
        </div>
      `;
    }

    function renderEquipamentos() {
      // Limpar todos os slots
      document.querySelectorAll('.equipment-slot').forEach(slot => {
        slot.classList.remove('has-item');
        const equippedItem = slot.querySelector('.equipped-item');
        if (equippedItem) {
          equippedItem.remove();
        }
      });

      // Renderizar itens equipados
      inventario.forEach((item, idx) => {
        if (!item.equipadoEm) return;
        
        let slotId = '';
        switch(item.equipadoEm) {
          case 'cabeca':
            slotId = 'slot-capacete';
            break;
          case 'torso':
            slotId = 'slot-armadura';
            break;
          case 'pes':
            slotId = 'slot-botas';
            break;
          case 'luvas':
            slotId = 'slot-luvas';
            break;
          case 'mao_principal':
            slotId = 'slot-arma-principal';
            break;
          case 'mao_secundaria':
            slotId = 'slot-arma-secundaria';
            break;
          case 'anel':
            // Para an√©is, usar primeiro slot dispon√≠vel
            const anel1 = document.getElementById('slot-anel1');
            const anel2 = document.getElementById('slot-anel2');
            if (!anel1.classList.contains('has-item')) {
              slotId = 'slot-anel1';
            } else if (!anel2.classList.contains('has-item')) {
              slotId = 'slot-anel2';
            }
            break;
          case 'colar':
            slotId = 'slot-colar';
            break;
        }
        
        if (slotId) {
          const slot = document.getElementById(slotId);
          if (slot) {
            slot.classList.add('has-item');
            
            const equippedDiv = document.createElement('div');
            equippedDiv.className = 'equipped-item';
            equippedDiv.innerHTML = `<div class="equipped-item-name">${item.nome}</div>`;
            equippedDiv.dataset.itemIndex = idx;
            
            // Adicionar menu de contexto
            equippedDiv.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              mostrarMenuEquipado(idx, e);
            });
            
            slot.appendChild(equippedDiv);
          }
        }
      });
    }

    // Fun√ß√µes para equipar/desequipar itens
    function mostrarMenuEquipar(itemIdx, event) {
      event.preventDefault();
      event.stopPropagation();
      
      const item = inventario[itemIdx];
      const menu = document.createElement('div');
      menu.className = 'fixed bg-white border rounded shadow-lg p-2';
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
      menu.style.zIndex = '10000'; // Z-index alto para aparecer acima dos modais
      
      const slotsCompativeis = getSlotsCompativeis(item);
      
      if (slotsCompativeis.length === 0) {
        menu.innerHTML = '<div class="text-sm text-gray-500 p-2">Item n√£o equip√°vel</div>';
      } else {
        menu.innerHTML = slotsCompativeis.map(slot => 
          `<button onclick="equiparItem(${itemIdx}, '${slot.value}')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">${slot.label}</button>`
        ).join('');
      }
      
      // Fechar menu ao clicar fora
      const fecharMenu = (e) => {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', fecharMenu);
        }
      };
      
      setTimeout(() => document.addEventListener('click', fecharMenu), 100);
      document.body.appendChild(menu);
    }

    function mostrarMenuEquipado(itemIdx, event) {
      event.preventDefault();
      event.stopPropagation();
      
      const menu = document.createElement('div');
      menu.className = 'fixed bg-white border rounded shadow-lg p-2';
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
      menu.style.zIndex = '10000'; // Z-index alto para aparecer acima dos modais
      
      menu.innerHTML = `
        <button onclick="desequiparItem(${itemIdx})" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">üì§ Desequipar</button>
        <button onclick="editarItem(${itemIdx})" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">‚úèÔ∏è Editar</button>
      `;
      
      const fecharMenu = (e) => {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', fecharMenu);
        }
      };
      
      setTimeout(() => document.addEventListener('click', fecharMenu), 100);
      document.body.appendChild(menu);
    }

    function getSlotsCompativeis(item) {
      const slots = [];
      
      switch(item.tipo) {
        case 'arma':
          slots.push(
            { value: 'mao_principal', label: '‚öîÔ∏è M√£o Principal' },
            { value: 'mao_secundaria', label: 'üó°Ô∏è M√£o Secund√°ria' }
          );
          break;
        case 'capacete':
          slots.push({ value: 'cabeca', label: 'ü™ñ Cabe√ßa' });
          break;
        case 'armadura':
          slots.push({ value: 'torso', label: 'ÔøΩÔ∏è Torso' });
          break;
        case 'luvas':
          slots.push({ value: 'luvas', label: 'üß§ Luvas' });
          break;
        case 'botas':
          slots.push({ value: 'pes', label: 'ÔøΩ P√©s' });
          break;
        case 'anel':
          slots.push({ value: 'anel', label: 'üíç Anel' });
          break;
        case 'colar':
          slots.push({ value: 'colar', label: 'üìø Colar' });
          break;
      }
      
      return slots;
    }

    function equiparItem(itemIdx, slot) {
      // Valida√ß√£o de entrada
      if (typeof itemIdx !== 'number' || itemIdx < 0 || itemIdx >= inventario.length) {
        console.error('√çndice de item inv√°lido para equipar:', itemIdx);
        return;
      }
      
      const item = inventario[itemIdx];
      if (!item) {
        console.error('Item n√£o encontrado no √≠ndice:', itemIdx);
        return;
      }
      
      console.log(`Equipando item "${item.nome}" no slot "${slot}"`);
      
      // Se o item tem quantidade > 1, perguntar se deve equipar separadamente
      if (item.quantidade > 1) {
        const equiparSeparadamente = confirm(`Este item tem quantidade ${item.quantidade}. Deseja equipar apenas uma unidade (recomendado) ou equipar todas as ${item.quantidade} unidades juntas?`);
        
        if (equiparSeparadamente) {
          // Criar uma nova entrada no invent√°rio apenas para o item equipado
          const itemEquipado = {
            ...item, // Copia todas as propriedades
            id: gerarGUID(), // Novo ID √∫nico
            quantidade: 1, // Apenas 1 unidade
            equipadoEm: slot // Equipado no slot escolhido
          };
          
          // Reduzir a quantidade do item original
          item.quantidade -= 1;
          
          // Adicionar o item equipado ao invent√°rio
          inventario.push(itemEquipado);
          
          // Salvar no localStorage
          localStorage.setItem('inventario', JSON.stringify(inventario));
          
          renderInventario();
          
          // Fechar menu
          document.querySelectorAll('.fixed.bg-white.border').forEach(menu => menu.remove());
          return;
        }
      }
      
      // Verificar se slot est√° ocupado (exceto an√©is que podem ter 2)
      if (slot !== 'anel') {
        const itemEquipado = inventario.find(i => i.equipadoEm === slot);
        if (itemEquipado) {
          if (!confirm(`J√° existe um item equipado em ${slot.replace('_', ' ')}. Deseja substituir?`)) {
            return;
          }
          itemEquipado.equipadoEm = '';
        }
      } else {
        // Para an√©is, verificar se j√° h√° 2 equipados
        const aneisEquipados = inventario.filter(i => i.equipadoEm === 'anel').length;
        if (aneisEquipados >= 2) {
          console.log('J√° existem 2 an√©is equipados. Desequipe um primeiro.');
          return;
        }
      }
      
      item.equipadoEm = slot;
      
      // Salvar no localStorage
      localStorage.setItem('inventario', JSON.stringify(inventario));
      
      renderInventario();
      
      // Fechar menu
      document.querySelectorAll('.fixed.bg-white.border').forEach(menu => menu.remove());
    }

    function desequiparItem(itemIdx) {
      // Valida√ß√£o de entrada
      if (typeof itemIdx !== 'number' || itemIdx < 0 || itemIdx >= inventario.length) {
        console.error('√çndice de item inv√°lido para desequipar:', itemIdx);
        return;
      }
      
      const item = inventario[itemIdx];
      if (!item) {
        console.error('Item n√£o encontrado no √≠ndice:', itemIdx);
        return;
      }
      
      console.log(`Desequipando item "${item.nome}"`);
      
      item.equipadoEm = '';
      
      // Salvar no localStorage
      localStorage.setItem('inventario', JSON.stringify(inventario));
      
      renderInventario();
      
      // Fechar menu
      document.querySelectorAll('.fixed.bg-white.border').forEach(menu => menu.remove());
    }

    function alterarQuantidade(itemIdx, delta) {
      // Valida√ß√£o de entrada
      if (typeof itemIdx !== 'number' || itemIdx < 0 || itemIdx >= inventario.length) {
        console.error('√çndice de item inv√°lido para alterar quantidade:', itemIdx);
        return;
      }
      
      const item = inventario[itemIdx];
      if (!item) {
        console.error('Item n√£o encontrado no √≠ndice:', itemIdx);
        return;
      }
      
      // Garantir que quantidade seja pelo menos 1
      if (!item.quantidade || item.quantidade < 1) {
        item.quantidade = 1;
      }
      
      // Aplicar a altera√ß√£o
      item.quantidade += delta;
      
      // Se a quantidade chegar a 0 ou menos, remover o item
      if (item.quantidade <= 0) {
        if (confirm(`Remover "${item.nome}" do invent√°rio?`)) {
          inventario.splice(itemIdx, 1);
          console.log(`Item "${item.nome}" removido do invent√°rio (quantidade chegou a 0)`);
        } else {
          // Se o usu√°rio cancelar, manter pelo menos 1
          item.quantidade = 1;
        }
      } else {
        console.log(`Quantidade de "${item.nome}" alterada para ${item.quantidade}`);
      }
      
      // Salvar no localStorage
      localStorage.setItem('inventario', JSON.stringify(inventario));
      
      // Re-renderizar invent√°rio
      renderInventario();
    }

    function abrirModalItem() {
      itemEditandoIndex = -1;
      // N√£o redefinir o t√≠tulo se j√° foi definido (para edi√ß√£o do gerenciador)
      if (!document.getElementById('tituloModalItem').textContent.includes('Gerenciador')) {
        document.getElementById('tituloModalItem').textContent = 'üì¶ Novo Item';
        limparFormularioItem();
      }
      
      // Position the window and show it
      const itemWindow = document.getElementById('itemWindow');
      itemWindow.style.top = '20%';
      itemWindow.style.right = '20px';
      
      itemWindow.classList.remove('hidden');
    }

    function editarItem(idx) {
      itemEditandoIndex = idx;
      const item = inventario[idx];
      document.getElementById('tituloModalItem').textContent = 'üì¶ Editar Item';
      
      // Preencher formul√°rio
      document.getElementById('itemNome').value = item.nome || '';
      document.getElementById('itemDescricao').value = item.descricao || '';
      document.getElementById('itemTipoDano').value = item.tipoDano || '';
      document.getElementById('itemRecuperaVida').value = item.recuperaVida || '';
      document.getElementById('itemRecupera').value = item.recupera || '';
      document.getElementById('itemConsumivel').value = item.consumivel || 'false';
      document.getElementById('itemPropriedades').value = item.propriedades || '';
      document.getElementById('itemPeso').value = item.peso || '';
      document.getElementById('itemTipo').value = item.tipo || '';
      document.getElementById('itemEquipadoEm').value = item.equipadoEm || '';
      
      // Position the window and show it
      const itemWindow = document.getElementById('itemWindow');
      itemWindow.style.top = '20%';
      itemWindow.style.right = '20px';
      
      itemWindow.classList.remove('hidden');
    }

    function limparFormularioItem() {
      document.getElementById('itemNome').value = '';
      document.getElementById('itemDescricao').value = '';
      document.getElementById('itemTipoDano').value = '';
      document.getElementById('itemRecuperaVida').value = '';
      document.getElementById('itemRecupera').value = '';
      document.getElementById('itemConsumivel').value = 'false';
      document.getElementById('itemRaridade').value = 'comum';
      document.getElementById('itemPropriedades').value = '';
      document.getElementById('itemPeso').value = '';
      document.getElementById('itemTipo').value = '';
      document.getElementById('itemEquipadoEm').value = '';
    }

    function salvarItem() {
      const item = {
        id: itemEditandoGerenciador ? itemEditandoGerenciador.id : gerarGUID(),
        nome: document.getElementById('itemNome').value,
        descricao: document.getElementById('itemDescricao').value,
        tipoDano: document.getElementById('itemTipoDano').value,
        recuperaVida: document.getElementById('itemRecuperaVida').value,
        recupera: document.getElementById('itemRecupera').value,
        consumivel: document.getElementById('itemConsumivel').value,
        raridade: document.getElementById('itemRaridade').value,
        propriedades: document.getElementById('itemPropriedades').value,
        peso: document.getElementById('itemPeso').value,
        tipo: document.getElementById('itemTipo').value,
        equipadoEm: document.getElementById('itemEquipadoEm').value
      };

      if (itemEditandoIndex >= 0) {
        // Editando item existente no invent√°rio
        inventario[itemEditandoIndex] = item;
        
        // Se existe no gerenciador, atualizar l√° tamb√©m
        const gerIndex = itensGerenciador.findIndex(i => i.id === item.id);
        if (gerIndex !== -1) {
          itensGerenciador[gerIndex] = item;
          salvarItensGerenciador();
        }
        
        renderInventario();
      } else if (itemEditandoGerenciador) {
        // Item vem do gerenciador - salvar apenas no gerenciador
        const existeIndex = itensGerenciador.findIndex(i => i.id === item.id);
        if (existeIndex !== -1) {
          itensGerenciador[existeIndex] = item;
        } else {
          itensGerenciador.push(item);
        }
        salvarItensGerenciador();
      } else {
        // Item novo do invent√°rio (caso ainda seja usado)
        inventario.push(item);
        renderInventario();
      }

      renderItensGerenciador();
      document.getElementById('itemWindow').classList.add('hidden');
      itemEditandoGerenciador = null;
      
      // Feedback visual de sucesso no console
      const nomeItem = item.nome || 'Item';
      console.log(`‚úÖ ${nomeItem} salvo com sucesso!`);
    }

    function removerItem(idx) {
      if (confirm('Tem certeza que deseja remover este item?')) {
        inventario.splice(idx, 1);
        renderInventario();
      }
    }

    // (Event listeners movidos para o bloco DOMContentLoaded unificado)

    // Event listeners para drag & drop nos slots
    document.querySelectorAll('.equipment-slot').forEach(slot => {
      slot.addEventListener('dragover', (e) => {
        e.preventDefault();
        slot.classList.add('drag-over');
      });

      slot.addEventListener('dragleave', () => {
        slot.classList.remove('drag-over');
      });

      slot.addEventListener('drop', (e) => {
        e.preventDefault();
        slot.classList.remove('drag-over');
        
        try {
          const dragDataStr = e.dataTransfer.getData('text/plain');
          
          // Tentar parsing como JSON primeiro (novo formato)
          let dragData;
          try {
            dragData = JSON.parse(dragDataStr);
          } catch {
            // Fallback para formato antigo (apenas √≠ndice)
            const itemIdx = parseInt(dragDataStr);
            if (isNaN(itemIdx) || itemIdx < 0 || itemIdx >= inventario.length) {
              console.error('√çndice de item inv√°lido:', dragDataStr);
              return;
            }
            dragData = {
              source: 'inventario',
              itemIndex: itemIdx,
              itemData: inventario[itemIdx]
            };
          }
          
          if (dragData.source === 'inventario') {
            const itemIdx = dragData.itemIndex;
            const item = dragData.itemData || inventario[itemIdx];
            const slotType = slot.dataset.slot;
            
            // Verificar se o √≠ndice √© v√°lido
            if (itemIdx < 0 || itemIdx >= inventario.length) {
              console.error('√çndice de item inv√°lido:', itemIdx);
              return;
            }
            
            // Verificar se o item √© compat√≠vel com o slot
            const slotsCompativeis = getSlotsCompativeis(item);
            const isCompatible = slotsCompativeis.some(s => s.value === slotType);
            
            if (isCompatible) {
              equiparItem(itemIdx, slotType);
            } else {
              console.log(`Item "${item.nome}" n√£o √© compat√≠vel com slot "${slotType}"`);
            }
          } else {
            console.log('Tentativa de equipar item que n√£o vem do invent√°rio');
          }
        } catch (error) {
          console.error('Erro ao processar drop no slot de equipamento:', error);
        }
      });

      // Click no slot para equipar
      slot.addEventListener('click', () => {
        if (slot.classList.contains('has-item')) return;
        
        const slotType = slot.dataset.slot;
        const itensCompativeis = inventario
          .map((item, idx) => ({ item, idx }))
          .filter(({ item }) => !item.equipadoEm && getSlotsCompativeis(item).some(s => s.value === slotType));
        
        if (itensCompativeis.length === 0) {
          alert('Nenhum item compat√≠vel dispon√≠vel para este slot.');
          return;
        }
        
        if (itensCompativeis.length === 1) {
          equiparItem(itensCompativeis[0].idx, slotType);
        } else {
          // Mostrar menu de sele√ß√£o
          const menu = document.createElement('div');
          menu.className = 'fixed bg-white border rounded shadow-lg p-2';
          const rect = slot.getBoundingClientRect();
          menu.style.left = rect.right + 10 + 'px';
          menu.style.top = rect.top + 'px';
          menu.style.zIndex = '10000'; // Z-index alto para aparecer acima dos modais
          
          menu.innerHTML = itensCompativeis.map(({ item, idx }) => 
            `<button onclick="equiparItem(${idx}, '${slotType}')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded">${item.nome}</button>`
          ).join('');
          
          const fecharMenu = (e) => {
            if (!menu.contains(e.target)) {
              menu.remove();
              document.removeEventListener('click', fecharMenu);
            }
          };
          
          setTimeout(() => document.addEventListener('click', fecharMenu), 100);
          document.body.appendChild(menu);
        }
      });
    });

    // --- INVENT√ÅRIO FLUTUANTE ARRAST√ÅVEL ---
(function() {
  let isDraggingInv = false;
  let dragStartXInv, dragStartYInv, initialXInv, initialYInv;
  const modalInventario = document.getElementById('modalInventario');
  const cabecalhoInventario = document.getElementById('cabecalhoInventario');

  if (cabecalhoInventario && modalInventario) {
    cabecalhoInventario.addEventListener('mousedown', function(e) {
      if (e.target.id === 'fecharModalInventario') return;
      isDraggingInv = true;
      dragStartXInv = e.clientX;
      dragStartYInv = e.clientY;
      const rect = modalInventario.getBoundingClientRect();
      initialXInv = rect.left;
      initialYInv = rect.top;
      modalInventario.style.cursor = 'grabbing';
      document.body.style.userSelect = 'none';
    });
    document.addEventListener('mousemove', function(e) {
      if (!isDraggingInv) return;
      e.preventDefault();
      const deltaX = e.clientX - dragStartXInv;
      const deltaY = e.clientY - dragStartYInv;
      const newX = Math.max(0, Math.min(window.innerWidth - modalInventario.offsetWidth, initialXInv + deltaX));
      const newY = Math.max(0, Math.min(window.innerHeight - modalInventario.offsetHeight, initialYInv + deltaY));
      modalInventario.style.left = newX + 'px';
      modalInventario.style.top = newY + 'px';
      modalInventario.style.right = 'auto';
    });
    document.addEventListener('mouseup', function() {
      if (isDraggingInv) {
        isDraggingInv = false;
        modalInventario.style.cursor = 'move';
        document.body.style.userSelect = '';
      }
    });
  }
})();

    // Funcionalidade de arrastar janela
    let isDragging = false;
    let dragStartX, dragStartY, initialX, initialY;

    const itemWindow = document.getElementById('itemWindow');
    const cabecalhoItem = document.getElementById('cabecalhoItem');

    cabecalhoItem.addEventListener('mousedown', function(e) {
      if (e.target.id === 'fecharModalItem') return; // N√£o arrastar se clicar no X
      
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      
      const rect = itemWindow.getBoundingClientRect();
      initialX = rect.left;
      initialY = rect.top;
      
      itemWindow.style.cursor = 'grabbing';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      
      e.preventDefault();
      
      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;
      
      const newX = Math.max(0, Math.min(window.innerWidth - itemWindow.offsetWidth, initialX + deltaX));
      const newY = Math.max(0, Math.min(window.innerHeight - itemWindow.offsetHeight, initialY + deltaY));
      
      itemWindow.style.left = newX + 'px';
      itemWindow.style.top = newY + 'px';
      itemWindow.style.right = 'auto'; // Remove right positioning
    });

    document.addEventListener('mouseup', function() {
      if (isDragging) {
        isDragging = false;
        itemWindow.style.cursor = 'move';
        document.body.style.userSelect = '';
      }
    });

    // --- MARCOS ---
    let marcos = [];

    function renderMarcos() {
      const container = document.getElementById('marcosContainer');
      container.innerHTML = '';
      if (!marcos.length) {
        container.innerHTML = '<div class="text-gray-400 text-sm">Nenhum marco adicionado.</div>';
        return;
      }
        // Op√ß√µes agrupadas igual ao select da rolagem de dados
        marcos.forEach((marco, idx) => {
          const div = document.createElement('div');
          div.className = 'border rounded-lg p-3 bg-white flex flex-col gap-2 relative';
          let selectHtml = `<label class=\"font-semibold text-xs\">Afeta</label><select class=\"border rounded p-1 text-xs mb-1\" onchange=\"atualizarMarco(${idx}, 'alvo', this.value)\">`;
          selectHtml += '<option value="">Selecione...</option>';
          // Grupo de atributos
          selectHtml += '<optgroup label="Atributos">';
          pericias.forEach(cat => {
            const selected = (marco.alvo === cat.nome) ? 'selected' : '';
            selectHtml += `<option value=\"${cat.nome}\" ${selected}>${cat.icon} ${cat.nome}</option>`;
          });
          selectHtml += '</optgroup>';
          // Grupo de per√≠cias
          selectHtml += '<optgroup label="Per√≠cias">';
          pericias.forEach(cat => {
            cat.habilidades.forEach(hab => {
              const selected = (marco.alvo === hab) ? 'selected' : '';
              selectHtml += `<option value=\"${hab}\" ${selected}>${cat.icon} ${cat.nome} - ${hab}</option>`;
            });
          });
          selectHtml += '</optgroup>';
          selectHtml += '</select>';
          div.innerHTML = `
            <button type=\"button\" class=\"absolute top-2 right-2 text-red-500 hover:text-red-700\" title=\"Remover\" onclick=\"removerMarco(${idx})\">&times;</button>
            <label class=\"font-semibold text-xs\">T√≠tulo</label>
            <input type=\"text\" class=\"border-b-2 border-gray-200 focus:border-blue-500 outline-none text-sm mb-1 bg-transparent\" value=\"${marco.titulo || ''}\" onchange=\"atualizarMarco(${idx}, 'titulo', this.value)\">
            <label class=\"font-semibold text-xs\">Descri√ß√£o</label>
            <textarea rows=\"2\" class=\"border rounded p-1 text-xs mb-1\" onchange=\"atualizarMarco(${idx}, 'descricao', this.value)\">${marco.descricao || ''}</textarea>
            <div class=\"grid grid-cols-4 gap-2 items-end\">
              <div>
                <label class=\"font-semibold text-xs\">Peso de Jogada</label>
                <input type=\"number\" class=\"border-b-2 border-gray-200 focus:border-blue-500 outline-none text-sm w-full\" value=\"${marco.peso || 0}\" onchange=\"atualizarMarco(${idx}, 'peso', this.value)\">
              </div>
              <div class=\"col-span-3\">
                ${selectHtml}
              </div>
            </div>
          `;
          container.appendChild(div);
        });
    }

    function adicionarMarco() {
      marcos.push({ titulo: '', descricao: '', peso: 0 });
      renderMarcos();
    }

    function removerMarco(idx) {
      marcos.splice(idx, 1);
      renderMarcos();
    }

    function atualizarMarco(idx, campo, valor) {
      if (campo === 'peso') valor = parseInt(valor) || 0;
      marcos[idx][campo] = valor;
    }

    // Unifica√ß√£o de todos os event listeners de inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded executado!');
      
      // Marcos
      if (document.getElementById('btnAddMarco')) {
        document.getElementById('btnAddMarco').addEventListener('click', adicionarMarco);
        renderMarcos();
      }

      // Imagem do personagem
      if (document.getElementById('imagemPersonagem')) {
        document.getElementById('imagemPersonagem').addEventListener('change', handleImageUpload);
      }

      // Habilidades
      if (document.getElementById('btnAddHabilidade')) {
        document.getElementById('btnAddHabilidade').onclick = function() {
          habilidades.push({ nome: '', descricao: '', jogabilidade: '' });
          renderHabilidades();
        };
      }

      // Carrega dados iniciais
      carregarDados();
      carregarItensGerenciador();

      // Disponibilizar fun√ß√µes de debug e manuten√ß√£o globalmente (remover em produ√ß√£o se desejar)
      window.debugSincronizacao = debugSincronizacao;
      window.debugEquipamentos = debugEquipamentos;
      window.limparDuplicatasGerenciador = limparDuplicatasGerenciador;
      window.limparDuplicatasPorConteudo = limparDuplicatasPorConteudo;
      
      // Disponibilizar fun√ß√µes de invent√°rio globalmente para os bot√µes onclick
      window.mostrarMenuEquipar = mostrarMenuEquipar;
      window.equiparItem = equiparItem;
      window.desequiparItem = desequiparItem;
      window.editarItem = editarItem;
      window.removerItem = removerItem;
      window.removerImagem = removerImagem;
      window.alterarQuantidade = alterarQuantidade;
      window.gerarGUID = gerarGUID;
      window.atualizarResumoInventario = atualizarResumoInventario;

      // Event Listeners para o invent√°rio
      if (document.getElementById('inventarioBtn')) {
        document.getElementById('inventarioBtn').onclick = function() {
          document.getElementById('modalInventario').classList.remove('hidden');
          renderInventario();
        };
      }
      if (document.getElementById('fecharModalInventario')) {
        document.getElementById('fecharModalInventario').onclick = function() {
          document.getElementById('modalInventario').classList.add('hidden');
        };
      }
      if (document.getElementById('fecharModalItem')) {
        document.getElementById('fecharModalItem').onclick = function() {
          document.getElementById('itemWindow').classList.add('hidden');
        };
      }
      if (document.getElementById('salvarItem')) {
        document.getElementById('salvarItem').onclick = salvarItem;
      }
      if (document.getElementById('cancelarItem')) {
        document.getElementById('cancelarItem').onclick = function() {
          document.getElementById('itemWindow').classList.add('hidden');
        };
      }
      if (document.getElementById('filtroTipo')) {
        document.getElementById('filtroTipo').addEventListener('change', renderInventarioTabela);
      }
      if (document.getElementById('buscaItem')) {
        document.getElementById('buscaItem').addEventListener('input', renderInventarioTabela);
      }

      // Gerenciador de Conte√∫do
      if (document.getElementById('gerenciadorBtn')) {
        console.log('Registrando event listener para gerenciadorBtn');
        document.getElementById('gerenciadorBtn').onclick = function() {
          // CRIAR MODAL DO ZERO - SOLU√á√ÉO QUE FUNCIONA
          const modalExistente = document.getElementById('modalGerenciador');
          if (modalExistente) modalExistente.remove();
          
          // Criar modal completo
          const modal = document.createElement('div');
          modal.id = 'modalGerenciador';
          modal.innerHTML = `
            <div id="cabecalhoGerenciador" style="background: #f3f4f6; padding: 16px; border-bottom: 1px solid #d1d5db; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none;">
              <h2 style="font-size: 18px; font-weight: bold; margin: 0;">üóÉÔ∏è Gerenciador de Conte√∫do</h2>
              <button onclick="this.closest('#modalGerenciador').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 20px; height: 520px; overflow-y: auto;">
              <!-- Abas -->
              <div style="display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 16px;">
                <button style="padding: 8px 16px; border-bottom: 2px solid #f97316; color: #f97316; font-weight: bold; background: none; border: none; cursor: pointer;">üì¶ Itens</button>
                <button style="padding: 8px 16px; color: #6b7280; background: none; border: none; cursor: not-allowed;" disabled>üèõÔ∏è Locais (Em breve)</button>
                <button style="padding: 8px 16px; color: #6b7280; background: none; border: none; cursor: not-allowed;" disabled>üë• NPCs (Em breve)</button>
              </div>
              
              <!-- Barra de ferramentas -->
              <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                <button onclick="criarNovoItemGerenciador()" style="background: #16a34a; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">‚ûï Criar Item</button>
                <button onclick="importarListaItens()" style="background: #2563eb; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">üì• Importar Lista</button>
                <button onclick="exportarListaItens()" style="background: #7c3aed; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">üì§ Exportar Lista</button>
                <div style="flex: 1;"></div>
                <input type="text" id="buscarItensGerenciador" placeholder="Buscar itens..." style="border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 12px; width: 250px;">
              </div>
              
              <!-- Filtros -->
              <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <select id="filtroTipoGerenciador" style="border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 12px;">
                  <option value="">Todos os tipos</option>
                  <option value="arma">Armas</option>
                  <option value="capacete">Capacetes</option>
                  <option value="armadura">Armaduras</option>
                  <option value="luvas">Luvas</option>
                  <option value="botas">Botas</option>
                  <option value="anel">An√©is</option>
                  <option value="colar">Colares/Amuletos</option>
                  <option value="consumivel">Consum√≠veis</option>
                  <option value="ferramenta">Ferramentas</option>
                  <option value="outro">Outros</option>
                </select>
                <select id="filtroRaridadeGerenciador" style="border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 12px;">
                  <option value="">Todas as raridades</option>
                  <option value="comum">Comum</option>
                  <option value="incomum">Incomum</option>
                  <option value="raro">Raro</option>
                  <option value="epico">√âpico</option>
                  <option value="lendario">Lend√°rio</option>
                </select>
              </div>
              
              <!-- Lista de Itens -->
              <div style="border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; padding: 16px; height: 350px; overflow-y: auto;">
                <div id="listaItensGerenciador" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">
                  <!-- Itens ser√£o renderizados aqui -->
                </div>
                <div id="nenhumItemGerenciador" style="text-align: center; color: #6b7280; padding: 32px 0; display: none;">
                  Nenhum item encontrado. Crie ou importe itens para come√ßar.
                </div>
              </div>
            </div>
          `;
          
          modal.style.cssText = `
            position: fixed;
            top: 50px;
            left: 50px;
            width: 900px;
            height: 700px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            z-index: 9999;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
          `;
          
          document.body.appendChild(modal);
          
          // Tornar o modal arrast√°vel
          tornarArrastavel('modalGerenciador', 'cabecalhoGerenciador');
          
          // Renderizar itens ap√≥s criar o modal
          renderItensGerenciador();
          
          // Adicionar event listeners para filtros
          document.getElementById('buscarItensGerenciador').addEventListener('input', renderItensGerenciador);
          document.getElementById('filtroTipoGerenciador').addEventListener('change', renderItensGerenciador);
          document.getElementById('filtroRaridadeGerenciador').addEventListener('change', renderItensGerenciador);
        };
      } else {
        console.log('ERRO: gerenciadorBtn n√£o encontrado!');
      }
      if (document.getElementById('adicionarItem')) {
        document.getElementById('adicionarItem').onclick = function() {
          const modal = document.getElementById('modalGerenciador');
          modal.classList.remove('hidden');
          renderItensGerenciador();
        };
      }
      if (document.getElementById('criarItemGerenciador'))
        document.getElementById('criarItemGerenciador').onclick = criarNovoItemGerenciador;
      if (document.getElementById('importarItensBtn'))
        document.getElementById('importarItensBtn').onclick = importarListaItens;
      if (document.getElementById('exportarItensBtn'))
        document.getElementById('exportarItensBtn').onclick = exportarListaItens;
      if (document.getElementById('importarItensInput'))
        document.getElementById('importarItensInput').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file && file.type === 'application/json') {
            const reader = new FileReader();
            reader.onload = function(event) {
              try {
                const importados = JSON.parse(event.target.result);
                if (Array.isArray(importados)) {
                  // Filtrar itens que j√° existem no gerenciador
                  const itensNovos = [];
                  const itensIgnorados = [];
                  
                  importados.forEach(item => {
                    // Verificar se j√° existe um item com o mesmo ID
                    const jaExiste = itensGerenciador.some(existente => existente.id === item.id);
                    
                    if (jaExiste) {
                      itensIgnorados.push(item);
                    } else {
                      // Garantir que o item tenha um ID v√°lido
                      if (!item.id) {
                        item.id = gerarGUIDUnicoGerenciador();
                      }
                      // Verificar novamente se o ID gerado n√£o conflita (dupla seguran√ßa)
                      if (!itensGerenciador.some(existente => existente.id === item.id)) {
                        itensNovos.push(item);
                      }
                    }
                  });
                  
                  // Adicionar apenas os itens novos
                  if (itensNovos.length > 0) {
                    itensGerenciador.push(...itensNovos);
                    salvarItensGerenciador();
                    renderItensGerenciador();
                  }
                  
                  // Log detalhado do resultado
                  console.log(`üì• Importa√ß√£o conclu√≠da:`);
                  console.log(`  ‚úÖ ${itensNovos.length} itens novos adicionados`);
                  console.log(`  ‚ö†Ô∏è ${itensIgnorados.length} itens ignorados (j√° existem)`);
                  console.log(`  üì¶ Total no gerenciador: ${itensGerenciador.length} itens`);
                  
                  if (itensIgnorados.length > 0) {
                    console.log(`\nüîç Itens ignorados:`, itensIgnorados.map(item => `${item.nome} (${item.id})`));
                  }
                } else {
                  console.error('Formato de arquivo inv√°lido. Esperado uma lista de itens.');
                }
              } catch (error) {
                console.error('Erro ao importar arquivo: ' + error.message);
              }
            };
            reader.readAsText(file);
          } else {
            console.error('Por favor, selecione um arquivo JSON v√°lido.');
          }
          e.target.value = '';
        });
      if (document.getElementById('buscarItensGerenciador'))
        document.getElementById('buscarItensGerenciador').addEventListener('input', renderItensGerenciador);
      if (document.getElementById('filtroTipoGerenciador'))
        document.getElementById('filtroTipoGerenciador').addEventListener('change', renderItensGerenciador);
      if (document.getElementById('filtroRaridadeGerenciador'))
        document.getElementById('filtroRaridadeGerenciador').addEventListener('change', renderItensGerenciador);
      if (document.getElementById('modalGerenciador') && document.getElementById('cabecalhoGerenciador'))
        tornarArrastavel('modalGerenciador', 'cabecalhoGerenciador');

      // Modal de rolagem de dados
      if (document.getElementById('rolarDadosBtn')) {
        const modal = document.getElementById('modalRolarDados');
        document.getElementById('rolarDadosBtn').onclick = () => {
          preencherSelectPericia();
          document.getElementById('divHabilidadeInterna').style.display = 'none';
          document.getElementById('resultadoRolagem').textContent = '';
          modal.classList.remove('hidden');
        };
      }
      if (document.getElementById('fecharModalRolar')) {
        document.getElementById('fecharModalRolar').onclick = () => {
          document.getElementById('modalRolarDados').classList.add('hidden');
        };
      }
      if (document.getElementById('selectPericia')) {
        document.getElementById('selectPericia').onchange = function() {
          document.getElementById('divHabilidadeInterna').style.display = 'none';
        };
      }
      if (document.getElementById('btnRolar')) {
        document.getElementById('btnRolar').onclick = function() {
          const val = document.getElementById('selectPericia').value;
          if (!val) {
            document.getElementById('resultadoRolagem').textContent = 'Selecione uma per√≠cia.';
            return;
          }
          const [catNome, habNome] = val.split('||');
          let dados = [], resultado, dadosBase = 1, modo = '';
          const pesoMarcos = calcularPesoMarcos(catNome, habNome);
          // Buscar treinamento dessa per√≠cia
          if (nivelPericiaAtual(habNome) >= 1) {
            dadosBase = 2;
            modo = 'melhor';
          }
          let totalDados = dadosBase + pesoMarcos;
          if (totalDados < 1) totalDados = 1;
          for (let i = 0; i < totalDados; i++) dados.push(rolarD10());
          if (modo === 'melhor') resultado = Math.max(...dados);
          else if (modo === 'pior') resultado = Math.min(...dados);
          else resultado = dados[0];
          let explicacaoBonus = '';
          if (pesoMarcos !== 0) explicacaoBonus += `<br><span class='text-xs text-blue-700'>Modificador de marcos: ${pesoMarcos > 0 ? '+' : ''}${pesoMarcos} dado(s)</span>`;
          const explicacao = `Per√≠cia: ${totalDados}d10${modo ? ' ('+modo+')' : ''}${explicacaoBonus}`;
          document.getElementById('resultadoRolagem').innerHTML =
            `<div class='mb-2'>${catNome} - <b>${habNome}</b></div>`+
            `<div class='mb-2'>${explicacao}</div>`+
            `<div class='mb-2'>Rolagem: <span class='font-mono text-xl'>${dados.join(' , ')}</span></div>`+
            `<div class='mb-2'>Resultado escolhido: <span class='font-bold text-2xl text-blue-700'>${resultado}</span></div>`;
        };
      }

      // === EVENT LISTENERS PARA DRAG AND DROP ===
      // Configurar drop zone para o invent√°rio
      setTimeout(() => {
        const inventarioTabela = document.getElementById('inventarioTabela');
        const modalInventario = document.getElementById('modalInventario');
        
        if (inventarioTabela && modalInventario) {
          // Adicionar classe visual para identificar como drop zone
          modalInventario.addEventListener('dragover', function(e) {
            e.preventDefault();
            
            // Verificar se estamos sobre um slot de equipamento
            const elementoAtivo = document.elementFromPoint(e.clientX, e.clientY);
            if (elementoAtivo && elementoAtivo.closest('.equipment-slot')) {
              return; // N√£o aplicar estilo se estiver sobre slot de equipamento
            }
            
            e.dataTransfer.dropEffect = 'copy';
            modalInventario.style.backgroundColor = '#f0f9ff';
            modalInventario.style.borderColor = '#0ea5e9';
          });

          modalInventario.addEventListener('dragleave', function(e) {
            // S√≥ remove o destaque se saiu completamente do modal E n√£o est√° sobre um slot
            const elementoDestino = e.relatedTarget;
            if (!modalInventario.contains(elementoDestino) || 
                (elementoDestino && elementoDestino.closest('.equipment-slot'))) {
              modalInventario.style.backgroundColor = '';
              modalInventario.style.borderColor = '#e5e7eb';
            }
          });

          modalInventario.addEventListener('drop', function(e) {
            e.preventDefault();
            modalInventario.style.backgroundColor = '';
            modalInventario.style.borderColor = '#e5e7eb';
            
            // Verificar se o drop foi em um slot de equipamento
            const elementoAtivo = document.elementFromPoint(e.clientX, e.clientY);
            if (elementoAtivo && elementoAtivo.closest('.equipment-slot')) {
              console.log('üéØ Drop redirecionado para slot de equipamento');
              return; // Deixar o slot de equipamento lidar com isso
            }
            
            try {
              const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
              console.log('Item arrastado para o invent√°rio:', dragData);
              
              if (dragData.source === 'gerenciador' && dragData.itemData) {
                const itemData = dragData.itemData;
                
                // Verificar se o item j√° est√° no invent√°rio usando o sistema de rastreamento
                const jaExiste = itemEstaNoInventario(itemData.id);
                
                if (jaExiste) {
                  console.log(`‚ÑπÔ∏è Item "${itemData.nome}" j√° est√° no invent√°rio!`);
                  return;
                }
                
                // Adicionar ao invent√°rio mantendo refer√™ncia ao gerenciador
                const novoItem = {
                  id: gerarGUID(), // Novo ID √∫nico para o invent√°rio
                  sourceId: itemData.id, // ID do item original no gerenciador (mais claro que gerenciadorId)
                  nome: itemData.nome || 'Item sem nome',
                  tipo: itemData.tipo || 'outro',
                  peso: parseFloat(itemData.peso) || 0,
                  raridade: itemData.raridade || 'comum',
                  descricao: itemData.descricao || '',
                  propriedades: itemData.propriedades || '',
                  tipoDano: itemData.tipoDano || '',
                  recuperaVida: itemData.recuperaVida || '',
                  recupera: itemData.recupera || '',
                  consumivel: itemData.consumivel || 'false',
                  equipadoEm: itemData.equipadoEm || '',
                  equipado: false,
                  quantidade: 1, // Quantidade padr√£o para novos itens
                  // Metadados para rastreamento
                  criadoEm: new Date().toISOString(),
                  origem: 'gerenciador'
                };
                
                // Adicionar ao array do invent√°rio
                inventario.push(novoItem);
                
                // Salvar no localStorage
                localStorage.setItem('inventario', JSON.stringify(inventario));
                
                // Atualizar a exibi√ß√£o do invent√°rio
                renderInventarioTabela();
                
                // Atualizar a exibi√ß√£o do gerenciador para mostrar que o item est√° no invent√°rio
                renderItensGerenciador();
                
                // Feedback visual no console
                console.log(`‚úÖ Item "${itemData.nome}" adicionado ao invent√°rio!`);
              } else if (dragData.source === 'inventario') {
                // Ignorar drags internos do invent√°rio - estes devem ser tratados pelos slots de equipamento
                console.log('üîÑ Drag interno do invent√°rio ignorado (deve ser tratado por slots de equipamento)');
                return;
              } else {
                console.error('Dados de drag inv√°lidos:', dragData);
              }
              
            } catch (error) {
              console.error('Erro ao processar item arrastado:', error);
            }
          });
        }
      }, 100);

    });
    // --- IMAGEM DO PERSONAGEM ---
    function compressImage(file, maxWidth, quality, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          let width = img.width;
          let height = img.height;
          if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
          }
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob((blob) => {
            const reader2 = new FileReader();
            reader2.onload = (e) => {
              callback(e.target.result);
            };
            reader2.readAsDataURL(blob);
          }, 'image/jpeg', quality);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        compressImage(file, 600, 0.7, (base64) => {
          document.getElementById('previewImagem').src = base64;
          document.getElementById('previewImagem').classList.remove('hidden');
          document.getElementById('removerImagem').classList.remove('hidden');
        });
      }
    }

    function removerImagem() {
      document.getElementById('previewImagem').src = '';
      document.getElementById('previewImagem').classList.add('hidden');
      document.getElementById('removerImagem').classList.add('hidden');
      document.getElementById('imagemPersonagem').value = '';
    }

    // Fun√ß√£o para carregar dados da ficha do localStorage
    function carregarDados() {
      // Carrega a ficha salva no localStorage, se existir
      const fichaSalva = localStorage.getItem('fichaRPG');
      if (fichaSalva) {
        try {
          const ficha = JSON.parse(fichaSalva);
          preencherFicha(ficha);
        } catch (e) {
          console.error('Erro ao carregar ficha salva:', e);
        }
      }
      
      // Carrega o invent√°rio salvo no localStorage
      const inventarioSalvo = localStorage.getItem('inventario');
      if (inventarioSalvo) {
        try {
          const inventarioCarregado = JSON.parse(inventarioSalvo);
          inventario.length = 0; // Limpar array
          inventario.push(...inventarioCarregado); // Adicionar itens carregados
          console.log('üì¶ Invent√°rio carregado:', inventario.length, 'itens');
          
          // Executar migra√ß√£o autom√°tica dos dados
          migrarDadosInventario();
        } catch (e) {
          console.error('Erro ao carregar invent√°rio salvo:', e);
        }
      }
      
      // Certifica-se de que as per√≠cias s√£o renderizadas corretamente
      renderPericias();
    }

  // (Removido: agora est√° tudo unificado no bloco acima)
    const pericias = [
      { icon: 'üí™', nome: 'Corpo', habilidades: ['Atletismo', 'Briga', 'Agilidade', 'Resist√™ncia'] },
      { icon: 'üß†', nome: 'Mente', habilidades: ['Investiga√ß√£o', 'Conhecimento Geral', 'Conhecimento Espec√≠fico', 'Intui√ß√£o'] },
      { icon: 'üó£Ô∏è', nome: 'Social', habilidades: ['L√°bia', 'Intimida√ß√£o', 'Interpreta√ß√£o', 'Lideran√ßa'] },
      { icon: 'üõ†Ô∏è', nome: 'T√©cnica', habilidades: ['Mira/Precis√£o', 'Medicina/Of√≠cios', 'Magia/Manuseio', 'Furtividade'] }
    ];

    function renderPericias() {
      const container = document.getElementById('periciasContainer');
      // Salvar o estado atual dos checkboxes antes de limpar
      const estadoPericias = {};
      document.querySelectorAll('input[data-pericia]').forEach(cb => {
        const pericia = cb.dataset.pericia;
        const nivel = cb.dataset.nivel;
        if (!estadoPericias[pericia]) {
          estadoPericias[pericia] = {};
        }
        estadoPericias[pericia][nivel] = cb.checked;
      });
      
      // Salvar o estado atual dos textareas
      const estadoTextareas = {};
      document.querySelectorAll('textarea[data-pericia-especifica]').forEach(textarea => {
        estadoTextareas[textarea.dataset.periciaEspecifica] = textarea.value;
      });
      
      // Limpar o container
      container.innerHTML = '';

      // Lista de per√≠cias que devem ter campo de habilidades expans√≠vel
      const periciasComInput = ['Conhecimento Geral', 'Conhecimento Espec√≠fico', 'Of√≠cios', 'Medicina/Of√≠cios'];

      pericias.forEach(categoria => {
        // Calcular quantidade de dados em efeito para a categoria
        let temIntermediario = false;
        let contadorPericiasTreinadas = 0;
        let todasPericiasTreinadas = true; // Para verificar se todas as per√≠cias est√£o treinadas (pelo menos n√≠vel 1)
        
        categoria.habilidades.forEach(hab => {
          // Verifica se h√° per√≠cias treinadas (n√≠vel 1) ou avan√ßadas (n√≠vel 2 ou 3)
          let nivelHab = 0;
          if (estadoPericias[hab]) {
            // Verifica o maior n√≠vel marcado
            if (estadoPericias[hab]['3'] && estadoPericias[hab]['3'] === true) nivelHab = 3;
            else if (estadoPericias[hab]['2'] && estadoPericias[hab]['2'] === true) nivelHab = 2;
            else if (estadoPericias[hab]['1'] && estadoPericias[hab]['1'] === true) nivelHab = 1;
          }
          
          if (nivelHab >= 2) temIntermediario = true;
          if (nivelHab >= 1) contadorPericiasTreinadas++;
          else todasPericiasTreinadas = false; // Se alguma per√≠cia n√£o estiver treinada, marca como falso
        });
        
        let dadosTexto = '';
        let temDadoBonus = todasPericiasTreinadas && categoria.habilidades.length >= 4;
        // Exibi√ß√£o simplificada: mostra 3d10 se houver b√¥nus de dado
        if (temDadoBonus) {
          // Se for 2d10 (melhor) +1, mostra 3d10 (melhor)
          if (temIntermediario && contadorPericiasTreinadas >= 2) {
            dadosTexto = '3d10 (melhor)';
          }
          // Se for 1d10 +1, mostra 2d10
          else if (temIntermediario || contadorPericiasTreinadas >= 2) {
            dadosTexto = '2d10';
          }
          // Se for 2d10 (pior) +1, mostra 3d10 (pior)
          else {
            dadosTexto = '3d10 (pior)';
          }
        } else {
          if (temIntermediario && contadorPericiasTreinadas >= 2) {
            dadosTexto = '2d10 (melhor)';
          } else if (temIntermediario) {
            dadosTexto = '1d10';
          } else if (contadorPericiasTreinadas >= 2) {
            dadosTexto = '1d10';
          } else {
            dadosTexto = '2d10 (pior)';
          }
        }

        const bloco = document.createElement('div');
        bloco.innerHTML = `<h3 class=\"font-bold text-lg mb-2 flex items-center gap-2\">${categoria.icon} ${categoria.nome} <span class='text-xs font-normal bg-blue-100 text-blue-700 px-2 py-0.5 rounded'>${dadosTexto}</span></h3>`;

        categoria.habilidades.forEach(nome => {
          const linha = document.createElement('div');
          linha.className = 'flex flex-col gap-1 mb-1';

          // Wrapper para alinhar label, √≠cone e checkboxes
          const linhaSuperior = document.createElement('div');
          linhaSuperior.className = 'flex items-center gap-2';

          // Sempre reserva espa√ßo para o √≠cone (expans√≠vel ou placeholder invis√≠vel)
          let expandIcon = null;
          const isExpansivel = periciasComInput.includes(nome);

          if (isExpansivel) {
            expandIcon = document.createElement('span');
            expandIcon.innerHTML = '<svg class="inline w-4 h-4 transition-transform" style="vertical-align:middle" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>';
            expandIcon.className = 'text-gray-500 mr-1 select-none cursor-pointer';
          } else {
            expandIcon = document.createElement('span');
            expandIcon.innerHTML = '<svg class="inline w-4 h-4" style="opacity:0;vertical-align:middle" viewBox="0 0 24 24"></svg>';
            expandIcon.className = 'mr-1';
          }
          linhaSuperior.appendChild(expandIcon);

          const label = document.createElement('span');
          label.className = 'w-40 select-none' + (isExpansivel ? ' cursor-pointer' : '');
          label.textContent = nome;

          linhaSuperior.appendChild(label);

          for (let i = 1; i <= 3; i++) {
            const checkboxId = `pericia-${nome.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}-${i}`;
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.name = checkboxId;
            checkbox.className = 'w-5 h-5 accent-blue-500';
            checkbox.dataset.pericia = nome;
            checkbox.dataset.nivel = i;
            
            // Restaurar estado
            if (estadoPericias[nome] && estadoPericias[nome][i] !== undefined) {
              checkbox.checked = estadoPericias[nome][i];
            }
            
            checkbox.addEventListener('change', handleNivelSelection);
            linhaSuperior.appendChild(checkbox);
            
            // Add hidden label for accessibility
            const checkboxLabel = document.createElement('label');
            checkboxLabel.htmlFor = checkboxId;
            checkboxLabel.className = 'sr-only'; // Screen reader only
            
            // Adiciona descri√ß√£o do n√≠vel nos labels para acessibilidade
            let nivelDesc = '';
            if (i === 1) nivelDesc = "Treinado";
            else if (i === 2) nivelDesc = "Intermedi√°rio";
            else nivelDesc = "Mestre";
            checkboxLabel.textContent = `${nivelDesc} (N√≠vel ${i}) para ${nome}`;
            
            linhaSuperior.appendChild(checkboxLabel);
          }

          linha.appendChild(linhaSuperior);

          // Campo expans√≠vel para habilidades, se for uma das per√≠cias selecionadas
          if (isExpansivel) {
            // Cria o campo oculto inicialmente
            const habilidadesDiv = document.createElement('div');
            habilidadesDiv.className = 'hidden mt-2';
            habilidadesDiv.style.marginLeft = '1.5rem';

            // Label e textarea para m√∫ltiplas habilidades
            const habilidadesLabel = document.createElement('label');
            habilidadesLabel.textContent = '';
            habilidadesLabel.className = 'block text-sm font-medium mb-1';
            const textareaId = `habilidades-${nome.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}`;
            habilidadesLabel.setAttribute('for', textareaId);

            const habilidadesTextarea = document.createElement('textarea');
            habilidadesTextarea.id = textareaId;
            habilidadesTextarea.name = textareaId;
            habilidadesTextarea.rows = 2;
            habilidadesTextarea.placeholder = 'Digite uma habilidade por linha';
            habilidadesTextarea.className = 'w-full border rounded p-1 text-xs leading-tight';
            habilidadesTextarea.style.minHeight = '28px';
            habilidadesTextarea.dataset.periciaEspecifica = nome;
            
            // Restaurar o conte√∫do do textarea
            if (estadoTextareas[nome] !== undefined) {
              habilidadesTextarea.value = estadoTextareas[nome];
            }

            habilidadesDiv.appendChild(habilidadesLabel);
            habilidadesDiv.appendChild(habilidadesTextarea);

            linha.appendChild(habilidadesDiv);

            // Toggle ao clicar no nome ou √≠cone
            const toggleExpand = () => {
              habilidadesDiv.classList.toggle('hidden');
              if (expandIcon && isExpansivel) {
                expandIcon.querySelector('svg').style.transform = habilidadesDiv.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
              }
            };
            label.addEventListener('click', toggleExpand);
            if (expandIcon && isExpansivel) expandIcon.addEventListener('click', toggleExpand);
          }

          bloco.appendChild(linha);
        });

        container.appendChild(bloco);
      });
    }

    function handleNivelSelection(e) {
      const cb = e.target;
      const nivel = parseInt(cb.dataset.nivel);
      const pericia = cb.dataset.pericia;

      // Busca os checkboxes desta per√≠cia
      const checkboxes = document.querySelectorAll(`input[data-pericia="${pericia}"]`);
      
      if (cb.checked) {
        // Se o checkbox foi marcado, marque tamb√©m todos os n√≠veis inferiores
        checkboxes.forEach(c => {
          if (parseInt(c.dataset.nivel) <= nivel) {
            c.checked = true;
          }
        });
      } else {
        // Se o checkbox foi desmarcado, desmarque tamb√©m todos os n√≠veis superiores
        checkboxes.forEach(c => {
          if (parseInt(c.dataset.nivel) >= nivel) {
            c.checked = false;
          }
        });
      }
      
      // Salva o estado atual para n√£o perder ao renderizar
      const estadoAtual = {};
      document.querySelectorAll('input[data-pericia]').forEach(checkbox => {
        const pericName = checkbox.dataset.pericia;
        const pericNivel = checkbox.dataset.nivel;
        if (!estadoAtual[pericName]) {
          estadoAtual[pericName] = {};
        }
        estadoAtual[pericName][pericNivel] = checkbox.checked;
      });
      
      // Renderiza as per√≠cias para atualizar a exibi√ß√£o
      renderPericias();
      
      // Restaura o estado ap√≥s renderizar
      document.querySelectorAll('input[data-pericia]').forEach(checkbox => {
        const pericName = checkbox.dataset.pericia;
        const pericNivel = checkbox.dataset.nivel;
        if (estadoAtual[pericName] && estadoAtual[pericName][pericNivel] !== undefined) {
          checkbox.checked = estadoAtual[pericName][pericNivel];
        }
      });
    }

    function limparFicha() {
      if (!confirm('Tem certeza que deseja limpar todos os dados da ficha? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }
      
      // Limpar localStorage
      localStorage.removeItem('fichaRPG');
      
      // Limpar campos de input e textarea
      document.querySelectorAll('input, textarea').forEach(el => el.value = '');
      document.querySelectorAll('#periciasContainer input[type="checkbox"]').forEach(cb => cb.checked = false);
      
      // Limpar imagem do personagem
      const imagemPersonagem = document.getElementById('previewImagem');
      if (imagemPersonagem) {
        imagemPersonagem.src = '';
        imagemPersonagem.style.display = 'none';
        imagemPersonagem.classList.add('hidden');
      }
      
      // Limpar input de arquivo da imagem
      const inputImagem = document.getElementById('imagemPersonagem');
      if (inputImagem) {
        inputImagem.value = '';
      }
      
      // Limpar invent√°rio
      inventario = [];
      renderInventario();
      
      // Limpar marcos
      marcos = [];
      renderMarcos();
      
      // Limpar habilidades
      habilidades = [];
      renderHabilidades();
      
      alert('Ficha apagada.');
    }

    function exportarFicha() {
      const ficha = coletarFicha();
      const blob = new Blob([JSON.stringify(ficha, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${ficha.nome || 'ficha'}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importarFicha(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const ficha = JSON.parse(e.target.result);
          preencherFicha(ficha);
          localStorage.setItem('fichaRPG', JSON.stringify(ficha));
          alert('Ficha importada com sucesso!');
        } catch {
          alert('Arquivo inv√°lido.');
        }
      };
      reader.readAsText(file);
    }

    function coletarFicha() {
      const ficha = {
        nome: document.getElementById('nome').value,
        apelido: document.getElementById('apelido').value,
        idade: document.getElementById('idade').value,
        genero: document.getElementById('genero').value,
        alinhamento: document.getElementById('alinhamento').value,
        altura: document.getElementById('altura').value,
        personalidade: document.getElementById('personalidade').value,
        historia: document.getElementById('historia').value,
        vinculos: document.getElementById('vinculos').value,
        observacoes: document.getElementById('observacoes').value,
        vocacao: document.getElementById('vocacao').value,
        especie: document.getElementById('especie').value,
        vidaAtual: document.getElementById('vidaAtual').value,
        vidaMaxima: document.getElementById('vidaMaxima').value,
        drive: document.getElementById('drive').value,
        imagemPersonagem: document.getElementById('previewImagem').src || '',
        pericias: {},
        periciasEspecificas: {},
        marcos: marcos.slice(),
  habilidades: habilidades.slice(),
  inventario: inventario.slice(),
  // Inclui tamb√©m a lista do gerenciador para restaurar junto na importa√ß√£o
  itensGerenciador: itensGerenciador.slice()
      };

      document.querySelectorAll('input[data-pericia]').forEach(cb => {
        const pericia = cb.dataset.pericia;
        const nivel = cb.dataset.nivel;
        
        if (!ficha.pericias[pericia]) {
          ficha.pericias[pericia] = {};
        }
        
        ficha.pericias[pericia][nivel] = cb.checked;
      });

      // Salva os valores dos campos de habilidades (textarea)
      document.querySelectorAll('textarea[data-pericia-especifica]').forEach(textarea => {
        ficha.periciasEspecificas[textarea.dataset.periciaEspecifica] = textarea.value;
      });

      return ficha;
    }

    function preencherFicha(ficha) {
  marcos = Array.isArray(ficha.marcos) ? ficha.marcos.slice() : [];
  renderMarcos();
  habilidades = Array.isArray(ficha.habilidades) ? ficha.habilidades.slice() : [];
  renderHabilidades();
  inventario = Array.isArray(ficha.inventario) ? ficha.inventario.slice() : [];
  // Persistir e re-renderizar o invent√°rio imediatamente ap√≥s importa√ß√£o
  try {
    localStorage.setItem('inventario', JSON.stringify(inventario));
  } catch {}
  try {
    migrarDadosInventario();
  } catch {}
  try {
    renderInventario();
  } catch {}
  // Restaurar e persistir itens do gerenciador, se vierem no arquivo
  if (Array.isArray(ficha.itensGerenciador)) {
    itensGerenciador = ficha.itensGerenciador.slice();
    try { salvarItensGerenciador(); } catch {}
  } else if (!Array.isArray(ficha.itensGerenciador) || (Array.isArray(ficha.itensGerenciador) && ficha.itensGerenciador.length === 0)) {
    // Se o arquivo n√£o trouxe a lista do gerenciador, derivar a partir do invent√°rio
    if (Array.isArray(inventario) && inventario.length > 0) {
      const mapaGer = new Map();
      inventario.forEach((item, idx) => {
        // Usar sourceId/gerenciadorId quando houver; caso contr√°rio, gerar e atribuir
        let sid = item.sourceId || item.gerenciadorId;
        if (!sid) {
          sid = gerarGUID();
          inventario[idx] = { ...item, sourceId: sid };
        }
        if (!mapaGer.has(sid)) {
          mapaGer.set(sid, {
            id: sid,
            nome: item.nome || 'Item',
            descricao: item.descricao || '',
            tipo: item.tipo || '',
            raridade: item.raridade || 'comum',
            tipoDano: item.tipoDano || '',
            recuperaVida: item.recuperaVida || '',
            recupera: item.recupera || '',
            consumivel: item.consumivel || 'false',
            propriedades: item.propriedades || '',
            peso: item.peso || '',
            equipadoEm: ''
          });
        }
      });
      itensGerenciador = Array.from(mapaGer.values());
      try { salvarItensGerenciador(); } catch {}
      try { localStorage.setItem('inventario', JSON.stringify(inventario)); } catch {}
    }
  }
  // Atualizar estado visual do gerenciador (se existir no DOM)
  try {
    renderItensGerenciador();
  } catch {}
      // Imagem do personagem
      if (ficha.imagemPersonagem) {
        document.getElementById('previewImagem').src = ficha.imagemPersonagem;
        document.getElementById('previewImagem').classList.remove('hidden');
        document.getElementById('removerImagem').classList.remove('hidden');
      } else {
        removerImagem();
      }
      document.getElementById('nome').value = ficha.nome || '';
      document.getElementById('apelido').value = ficha.apelido || '';
      document.getElementById('idade').value = ficha.idade || '';
      document.getElementById('genero').value = ficha.genero || '';
      document.getElementById('alinhamento').value = ficha.alinhamento || '';
      document.getElementById('altura').value = ficha.altura || '';
  document.getElementById('personalidade').value = ficha.personalidade || '';
  document.getElementById('historia').value = ficha.historia || '';
  document.getElementById('vinculos').value = ficha.vinculos || '';
  document.getElementById('observacoes').value = ficha.observacoes || '';
  document.getElementById('vocacao').value = ficha.vocacao || '';
  document.getElementById('especie').value = ficha.especie || '';
  document.getElementById('vidaAtual').value = ficha.vidaAtual || 0;
  document.getElementById('vidaMaxima').value = ficha.vidaMaxima || 0;
  document.getElementById('drive').value = ficha.drive || '';

      // Guarda o estado das per√≠cias para aplicar ap√≥s renderizar
      const estadoPericias = ficha.pericias || {};
      const estadoPericiasEspecificas = ficha.periciasEspecificas || {};

      // Renderiza as per√≠cias
      renderPericias();

      // Aplica o estado das per√≠cias ap√≥s renderizar
      setTimeout(() => {
        // Aplica o estado dos checkboxes
        document.querySelectorAll('input[data-pericia]').forEach(cb => {
          const pericia = cb.dataset.pericia;
          const nivel = cb.dataset.nivel;
          if (estadoPericias[pericia] && estadoPericias[pericia][nivel] !== undefined) {
            cb.checked = estadoPericias[pericia][nivel];
          }
        });
        // Aplica o valor dos textareas
        document.querySelectorAll('textarea[data-pericia-especifica]').forEach(textarea => {
          const pericia = textarea.dataset.periciaEspecifica;
          if (estadoPericiasEspecificas[pericia] !== undefined) {
            textarea.value = estadoPericiasEspecificas[pericia];
          }
        });
        // Chama renderPericias novamente para atualizar a exibi√ß√£o dos dados
        renderPericias();
      }, 50);
    }

    renderPericias();

    // --- ROLAGEM DE DADOS ---
    // Utilidades para rolagem
    function rolarD10() {
      return Math.floor(Math.random() * 10) + 1;
    }

    // Preencher selects do modal
    function preencherSelectPericia() {
      const select = document.getElementById('selectPericia');
      select.innerHTML = '<option value="">Selecione...</option>';
      // Adiciona op√ß√£o para rolar a categoria principal
      pericias.forEach(cat => {
        const optCat = document.createElement('option');
        optCat.value = cat.nome + '||';
        optCat.textContent = `${cat.icon} ${cat.nome} (Categoria)`;
        select.appendChild(optCat);
        cat.habilidades.forEach(hab => {
          const opt = document.createElement('option');
          opt.value = cat.nome + '||' + hab;
          opt.textContent = `${cat.icon} ${cat.nome} - ${hab}`;
          select.appendChild(opt);
        });
      });
    }

    // Modal: abrir/fechar
    const modal = document.getElementById('modalRolarDados');
    document.getElementById('rolarDadosBtn').onclick = () => {
      preencherSelectPericia();
      document.getElementById('divHabilidadeInterna').style.display = 'none';
      document.getElementById('resultadoRolagem').textContent = '';
      modal.classList.remove('hidden');
    };
    document.getElementById('fecharModalRolar').onclick = () => {
      modal.classList.add('hidden');
    };

    // Modal: sele√ß√£o de per√≠cia/habilidade
    document.getElementById('selectPericia').onchange = function() {
      // Para este sistema, toda per√≠cia j√° √© "interna" (n√£o h√° subn√≠veis), mas se quiser expandir, adapte aqui
      document.getElementById('divHabilidadeInterna').style.display = 'none';
    };

    // Modal: rolar dados
    document.getElementById('btnRolar').onclick = function() {
      const val = document.getElementById('selectPericia').value;
      if (!val) {
        document.getElementById('resultadoRolagem').textContent = 'Selecione uma per√≠cia.';
        return;
      }
      const [catNome, habNome] = val.split('||');
      let nivel = 0;
      let isCategoria = !habNome;
      let explicacao = '';
      let dados = [];
      let resultado = 0;

      // --- C√°lculo de modificadores de marcos ---
      // Para categoria: soma todos os marcos cujo alvo √© o atributo
      // Para per√≠cia: soma todos os marcos cujo alvo √© a per√≠cia
      let pesoMarcos = 0;
      if (isCategoria) {
        pesoMarcos = marcos.filter(m => m.alvo === catNome).reduce((acc, m) => acc + (parseInt(m.peso) || 0), 0);
      } else {
        pesoMarcos = marcos.filter(m => m.alvo === habNome).reduce((acc, m) => acc + (parseInt(m.peso) || 0), 0);
      }

      // --- L√≥gica de rolagem ---
      if (isCategoria) {
        let temIntermediario = false;
        let contadorPericiasTreinadas = 0;
        let todasPericiasTreinadas = true;
        const cat = pericias.find(c => c.nome === catNome);
        if (cat) {
          cat.habilidades.forEach(hab => {
            const cbs = document.querySelectorAll(`input[data-pericia='${hab}']`);
            let nivelHab = 0;
            cbs.forEach(cb => { if (cb.checked) nivelHab = Math.max(nivelHab, parseInt(cb.dataset.nivel)); });
            if (nivelHab >= 2) temIntermediario = true;
            if (nivelHab >= 1) contadorPericiasTreinadas++;
            else todasPericiasTreinadas = false;
          });
        }
        let temDadoBonus = todasPericiasTreinadas && cat && cat.habilidades.length >= 4;
        let dadosBase = 0;
        let modo = '';
        if (temIntermediario && contadorPericiasTreinadas >= 2) {
          dadosBase = 2;
          modo = 'melhor';
        } else if (temIntermediario) {
          dadosBase = 1;
          modo = '';
        } else if (contadorPericiasTreinadas >= 2) {
          dadosBase = 1;
          modo = '';
        } else {
          dadosBase = 2;
          modo = 'pior';
        }
        let totalDados = dadosBase + (temDadoBonus ? 1 : 0) + pesoMarcos;
        if (totalDados < 1) totalDados = 1;
        // Rolagem dos dados
        for (let i = 0; i < totalDados; i++) dados.push(rolarD10());
        if (modo === 'melhor') resultado = Math.max(...dados);
        else if (modo === 'pior') resultado = Math.min(...dados);
        else resultado = dados[0];
        let explicacaoBonus = '';
        if (pesoMarcos !== 0) explicacaoBonus += `<br><span class='text-xs text-blue-700'>Modificador de marcos: ${pesoMarcos > 0 ? '+' : ''}${pesoMarcos} dado(s)</span>`;
        if (temDadoBonus) explicacaoBonus += `<br><span class='text-xs text-green-700'>B√¥nus: +1 dado por todas as per√≠cias treinadas</span>`;
        explicacao = `Categoria: ${totalDados}d10${modo ? ' ('+modo+')' : ''}${explicacaoBonus}`;
        document.getElementById('resultadoRolagem').innerHTML =
          `<div class='mb-2'><b>${catNome}</b> (Categoria)</div>`+
          `<div class='mb-2'>${explicacao}</div>`+
          `<div class='mb-2'>Rolagem: <span class='font-mono text-xl'>${dados.join(' , ')}</span></div>`+
          `<div class='mb-2'>Resultado escolhido: <span class='font-bold text-2xl text-blue-700'>${resultado}</span></div>`;
        return;
      }
      // Per√≠cia individual
      const cbs = document.querySelectorAll(`input[data-pericia='${habNome}']`);
      cbs.forEach(cb => { if (cb.checked) nivel = Math.max(nivel, parseInt(cb.dataset.nivel)); });
      let dadosBase = 0;
      let modo = '';
      if (nivel === 0) {
        dadosBase = 2;
        modo = 'pior';
      } else if (nivel === 1) {
        dadosBase = 1;
        modo = '';
      } else {
        dadosBase = 2;
        modo = 'melhor';
      }
      let totalDados = dadosBase + pesoMarcos;
      if (totalDados < 1) totalDados = 1;
      for (let i = 0; i < totalDados; i++) dados.push(rolarD10());
      if (modo === 'melhor') resultado = Math.max(...dados);
      else if (modo === 'pior') resultado = Math.min(...dados);
      else resultado = dados[0];
      let explicacaoBonus = '';
      if (pesoMarcos !== 0) explicacaoBonus += `<br><span class='text-xs text-blue-700'>Modificador de marcos: ${pesoMarcos > 0 ? '+' : ''}${pesoMarcos} dado(s)</span>`;
      explicacao = `Per√≠cia: ${totalDados}d10${modo ? ' ('+modo+')' : ''}${explicacaoBonus}`;
      document.getElementById('resultadoRolagem').innerHTML =
        `<div class='mb-2'>${catNome} - <b>${habNome}</b></div>`+
        `<div class='mb-2'>${explicacao}</div>`+
        `<div class='mb-2'>Rolagem: <span class='font-mono text-xl'>${dados.join(' , ')}</span></div>`+
        `<div class='mb-2'>Resultado escolhido: <span class='font-bold text-2xl text-blue-700'>${resultado}</span></div>`;
    };
  </script>
</body>
</html>
