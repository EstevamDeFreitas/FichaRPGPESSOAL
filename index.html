<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de RPG</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-md">
    <h1 class="text-2xl font-bold mb-4 text-center">üìú Ficha de RPG</h1>

    <!-- Dados b√°sicos -->
    <div class="mb-6">
      <label class="block font-semibold">Nome</label>
      <input id="nome" type="text" class="w-full border rounded p-2 mb-4">

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block font-semibold">Voca√ß√£o</label>
          <input id="vocacao" type="text" class="w-full border rounded p-2">
        </div>
        <div>
          <label class="block font-semibold">Esp√©cie</label>
          <input id="especie" type="text" class="w-full border rounded p-2">
        </div>
      </div>

      <div class="grid grid-cols-4 gap-4">
        <div>
          <label class="block font-semibold">Vida Atual</label>
          <input id="vidaAtual" type="number" min="0" class="w-full border rounded p-2">
        </div>
        <div>
          <label class="block font-semibold">Vida M√°xima</label>
          <input id="vidaMaxima" type="number" min="0" class="w-full border rounded p-2">
        </div>
      </div>
    </div>

    <!-- Per√≠cias -->
    <h2 class="text-xl font-bold mb-2">üé≤ Per√≠cias</h2>

    <div id="periciasContainer" class="space-y-6"></div>

    <!-- Bot√µes -->
    <div class="flex gap-4 justify-center mt-6 flex-wrap">
      <button onclick="limparFicha()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl">Limpar</button>
      <button onclick="exportarFicha()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-xl">Exportar</button>
      <input type="file" id="importarInput" accept=".json" class="hidden" onchange="importarFicha(event)">
      <button onclick="document.getElementById('importarInput').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl">Importar</button>
    </div>

    <!-- Bot√£o fixo de rolagem de dados -->
  <button id="rolarDadosBtn" title="Rolar Dados" class="fixed right-0 top-1/2 z-50 bg-blue-600 hover:bg-blue-700 text-white rounded-l-xl rounded-r-none shadow-lg w-16 h-16 flex items-center justify-center border-r-4 border-blue-800" style="transform: translateY(-50%);">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061A1.125 1.125 0 0 1 3 16.811V8.69ZM12.75 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061a1.125 1.125 0 0 1-1.683-.977V8.69Z" />
        </svg>
    </button>

    <!-- Modal de rolagem de dados -->
    <div id="modalRolarDados" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
        <button id="fecharModalRolar" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span>üé≤</span> Rolar Dados de Per√≠cia</h2>
        <div class="mb-4">
          <label class="block font-semibold mb-1">Per√≠cia</label>
          <select id="selectPericia" class="w-full border rounded p-2">
            <option value="">Selecione...</option>
          </select>
        </div>
        <div class="mb-4" id="divHabilidadeInterna" style="display:none;">
          <label class="block font-semibold mb-1">Habilidade</label>
          <select id="selectHabilidadeInterna" class="w-full border rounded p-2"></select>
        </div>
        <button id="btnRolar" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl w-full font-bold">Rolar Dados</button>
        <div id="resultadoRolagem" class="mt-4 text-center text-lg font-semibold"></div>
      </div>
    </div>

  <script>
    const pericias = [
      { icon: 'üí™', nome: 'Corpo', habilidades: ['Atletismo', 'Briga', 'Agilidade', 'Resist√™ncia'] },
      { icon: 'üß†', nome: 'Mente', habilidades: ['Investiga√ß√£o', 'Conhecimento Geral', 'Conhecimento Espec√≠fico', 'Intui√ß√£o'] },
      { icon: 'üó£Ô∏è', nome: 'Social', habilidades: ['L√°bia', 'Intimida√ß√£o', 'Interpreta√ß√£o', 'Lideran√ßa'] },
      { icon: 'üõ†Ô∏è', nome: 'T√©cnica', habilidades: ['Mira/Precis√£o', 'Medicina/Of√≠cios', 'Magia/Manuseio', 'Furtividade'] }
    ];

    function renderPericias() {
      const container = document.getElementById('periciasContainer');
      container.innerHTML = '';

      // Lista de per√≠cias que devem ter campo de habilidades expans√≠vel
      const periciasComInput = ['Conhecimento Geral', 'Conhecimento Espec√≠fico', 'Of√≠cios', 'Medicina/Of√≠cios'];

      pericias.forEach(categoria => {
        const bloco = document.createElement('div');
        bloco.innerHTML = `<h3 class=\"font-bold text-lg mb-2\">${categoria.icon} ${categoria.nome}</h3>`;

        categoria.habilidades.forEach(nome => {
          const linha = document.createElement('div');
          linha.className = 'flex flex-col gap-1 mb-1';

          // Wrapper para alinhar label, √≠cone e checkboxes
          const linhaSuperior = document.createElement('div');
          linhaSuperior.className = 'flex items-center gap-2';

          // Sempre reserva espa√ßo para o √≠cone (expans√≠vel ou placeholder invis√≠vel)
          let expandIcon = null;
          const isExpansivel = periciasComInput.includes(nome);

          if (isExpansivel) {
            expandIcon = document.createElement('span');
            expandIcon.innerHTML = '<svg class="inline w-4 h-4 transition-transform" style="vertical-align:middle" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>';
            expandIcon.className = 'text-gray-500 mr-1 select-none';
          } else {
            expandIcon = document.createElement('span');
            expandIcon.innerHTML = '<svg class="inline w-4 h-4" style="opacity:0;vertical-align:middle" viewBox="0 0 24 24"></svg>';
            expandIcon.className = 'mr-1';
          }
          linhaSuperior.appendChild(expandIcon);

          const label = document.createElement('span');
          label.className = 'w-40 select-none' + (isExpansivel ? ' cursor-pointer' : '');
          label.textContent = nome;

          linhaSuperior.appendChild(label);

          for (let i = 1; i <= 3; i++) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'w-5 h-5 accent-blue-500';
            checkbox.dataset.pericia = nome;
            checkbox.dataset.nivel = i;
            checkbox.addEventListener('change', handleNivelSelection);
            linhaSuperior.appendChild(checkbox);
          }

          linha.appendChild(linhaSuperior);

          // Campo expans√≠vel para habilidades, se for uma das per√≠cias selecionadas
          if (isExpansivel) {
            // Cria o campo oculto inicialmente
            const habilidadesDiv = document.createElement('div');
            habilidadesDiv.className = 'hidden mt-2';
            habilidadesDiv.style.marginLeft = '1.5rem';

            // Label e textarea para m√∫ltiplas habilidades
            const habilidadesLabel = document.createElement('label');
            habilidadesLabel.textContent = 'Habilidades:';
            habilidadesLabel.className = 'block text-sm font-medium mb-1';

            const habilidadesTextarea = document.createElement('textarea');
            habilidadesTextarea.rows = 2;
            habilidadesTextarea.placeholder = 'Digite uma habilidade por linha';
            habilidadesTextarea.className = 'w-full border rounded p-1 text-sm';
            habilidadesTextarea.dataset.periciaEspecifica = nome;

            habilidadesDiv.appendChild(habilidadesLabel);
            habilidadesDiv.appendChild(habilidadesTextarea);

            linha.appendChild(habilidadesDiv);

            // Toggle ao clicar no nome ou √≠cone
            const toggleExpand = () => {
              habilidadesDiv.classList.toggle('hidden');
              if (expandIcon && isExpansivel) {
                expandIcon.querySelector('svg').style.transform = habilidadesDiv.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
              }
            };
            label.addEventListener('click', toggleExpand);
            if (expandIcon && isExpansivel) expandIcon.addEventListener('click', toggleExpand);
          }

          bloco.appendChild(linha);
        });

        container.appendChild(bloco);
      });
    }

    function handleNivelSelection(e) {
      const cb = e.target;
      const nivel = parseInt(cb.dataset.nivel);
      const pericia = cb.dataset.pericia;

      const checkboxes = [...document.querySelectorAll(`#periciasContainer input[data-pericia='${pericia}']`)];

      if (cb.checked) {
        checkboxes.forEach(c => {
          if (parseInt(c.dataset.nivel) <= nivel) c.checked = true;
        });
      } else {
        checkboxes.forEach(c => {
          if (parseInt(c.dataset.nivel) >= nivel) c.checked = false;
        });
      }
    }

    function limparFicha() {
      localStorage.removeItem('fichaRPG');
      document.querySelectorAll('input, textarea').forEach(el => el.value = '');
      document.querySelectorAll('#periciasContainer input[type="checkbox"]').forEach(cb => cb.checked = false);
      alert('Ficha apagada.');
    }

    function exportarFicha() {
      const ficha = coletarFicha();
      const blob = new Blob([JSON.stringify(ficha, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${ficha.nome || 'ficha'}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importarFicha(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const ficha = JSON.parse(e.target.result);
          preencherFicha(ficha);
          localStorage.setItem('fichaRPG', JSON.stringify(ficha));
          alert('Ficha importada com sucesso!');
        } catch {
          alert('Arquivo inv√°lido.');
        }
      };
      reader.readAsText(file);
    }

    function coletarFicha() {
      const ficha = {
        nome: document.getElementById('nome').value,
        vocacao: document.getElementById('vocacao').value,
        especie: document.getElementById('especie').value,
        vidaAtual: document.getElementById('vidaAtual').value,
        vidaMaxima: document.getElementById('vidaMaxima').value,
        pericias: {},
        periciasEspecificas: {}
      };

      document.querySelectorAll('#periciasContainer input[type="checkbox"]').forEach(cb => {
        if (!ficha.pericias[cb.dataset.pericia]) {
          ficha.pericias[cb.dataset.pericia] = {};
        }
        ficha.pericias[cb.dataset.pericia][cb.dataset.nivel] = cb.checked;
      });

      // Salva os valores dos campos de habilidades (textarea)
      document.querySelectorAll('#periciasContainer textarea[data-pericia-especifica]').forEach(textarea => {
        ficha.periciasEspecificas[textarea.dataset.periciaEspecifica] = textarea.value;
      });

      return ficha;
    }

    function preencherFicha(ficha) {
      document.getElementById('nome').value = ficha.nome || '';
      document.getElementById('vocacao').value = ficha.vocacao || '';
      document.getElementById('especie').value = ficha.especie || '';
      document.getElementById('vidaAtual').value = ficha.vidaAtual || 0;
      document.getElementById('vidaMaxima').value = ficha.vidaMaxima || 0;

      document.querySelectorAll('#periciasContainer input[type="checkbox"]').forEach(cb => {
        cb.checked = ficha.pericias?.[cb.dataset.pericia]?.[cb.dataset.nivel] || false;
      });

      // Preenche os valores dos campos de habilidades (textarea)
      if (ficha.periciasEspecificas) {
        document.querySelectorAll('#periciasContainer textarea[data-pericia-especifica]').forEach(textarea => {
          textarea.value = ficha.periciasEspecificas[textarea.dataset.periciaEspecifica] || '';
        });
      }
    }

    renderPericias();

    // --- ROLAGEM DE DADOS ---
    // Utilidades para rolagem
    function rolarD10() {
      return Math.floor(Math.random() * 10) + 1;
    }

    // Preencher selects do modal
    function preencherSelectPericia() {
      const select = document.getElementById('selectPericia');
      select.innerHTML = '<option value="">Selecione...</option>';
      // Adiciona op√ß√£o para rolar a categoria principal
      pericias.forEach(cat => {
        const optCat = document.createElement('option');
        optCat.value = cat.nome + '||';
        optCat.textContent = `${cat.icon} ${cat.nome} (Categoria)`;
        select.appendChild(optCat);
        cat.habilidades.forEach(hab => {
          const opt = document.createElement('option');
          opt.value = cat.nome + '||' + hab;
          opt.textContent = `${cat.icon} ${cat.nome} - ${hab}`;
          select.appendChild(opt);
        });
      });
    }

    // Modal: abrir/fechar
    const modal = document.getElementById('modalRolarDados');
    document.getElementById('rolarDadosBtn').onclick = () => {
      preencherSelectPericia();
      document.getElementById('divHabilidadeInterna').style.display = 'none';
      document.getElementById('resultadoRolagem').textContent = '';
      modal.classList.remove('hidden');
    };
    document.getElementById('fecharModalRolar').onclick = () => {
      modal.classList.add('hidden');
    };

    // Modal: sele√ß√£o de per√≠cia/habilidade
    document.getElementById('selectPericia').onchange = function() {
      // Para este sistema, toda per√≠cia j√° √© "interna" (n√£o h√° subn√≠veis), mas se quiser expandir, adapte aqui
      document.getElementById('divHabilidadeInterna').style.display = 'none';
    };

    // Modal: rolar dados
    document.getElementById('btnRolar').onclick = function() {
      const val = document.getElementById('selectPericia').value;
      if (!val) {
        document.getElementById('resultadoRolagem').textContent = 'Selecione uma per√≠cia.';
        return;
      }
      const [catNome, habNome] = val.split('||');
      let nivel = 0;
      let isCategoria = !habNome;
      let explicacao = '';
      let dados = [];
      let resultado = 0;
      if (isCategoria) {
        // Rolar pela categoria principal
        // Busca todos os n√≠veis das per√≠cias dessa categoria
        let temIntermediario = false;
        let temIniciante = false;
        const cat = pericias.find(c => c.nome === catNome);
        if (cat) {
          cat.habilidades.forEach(hab => {
            const cbs = document.querySelectorAll(`#periciasContainer input[data-pericia='${hab}']`);
            let nivelHab = 0;
            cbs.forEach(cb => { if (cb.checked) nivelHab = Math.max(nivelHab, parseInt(cb.dataset.nivel)); });
            if (nivelHab >= 2) temIntermediario = true;
            else if (nivelHab === 1) temIniciante = true;
          });
        }
        if (temIntermediario) {
          dados = [rolarD10(), rolarD10()];
          resultado = Math.max(...dados);
          explicacao = 'Categoria: 2d10 (melhor resultado, pois h√° pelo menos uma per√≠cia intermedi√°ria/mestre)';
        } else if (temIniciante) {
          dados = [rolarD10()];
          resultado = dados[0];
          explicacao = 'Categoria: 1d10 (h√° pelo menos uma per√≠cia iniciante)';
        } else {
          dados = [rolarD10(), rolarD10()];
          resultado = Math.min(...dados);
          explicacao = 'Categoria: 2d10 (pior resultado, pois n√£o h√° nenhuma per√≠cia treinada)';
        }
        document.getElementById('resultadoRolagem').innerHTML =
          `<div class='mb-2'><b>${catNome}</b> (Categoria)</div>`+
          `<div class='mb-2'>${explicacao}</div>`+
          `<div class='mb-2'>Rolagem: <span class='font-mono text-xl'>${dados.join(' , ')}</span></div>`+
          `<div class='mb-2'>Resultado escolhido: <span class='font-bold text-2xl text-blue-700'>${resultado}</span></div>`;
        return;
      }
      // Per√≠cia individual (como antes)
      const cbs = document.querySelectorAll(`#periciasContainer input[data-pericia='${habNome}']`);
      cbs.forEach(cb => { if (cb.checked) nivel = Math.max(nivel, parseInt(cb.dataset.nivel)); });
      if (nivel === 0) {
        dados = [rolarD10(), rolarD10()];
        resultado = Math.min(...dados);
        explicacao = 'N√£o treinado: 2d10 (pior resultado)';
      } else if (nivel === 1) {
        dados = [rolarD10()];
        resultado = dados[0];
        explicacao = 'Treinado: 1d10';
      } else {
        dados = [rolarD10(), rolarD10()];
        resultado = Math.max(...dados);
        explicacao = 'Avan√ßado/Mestre: 2d10 (melhor resultado)';
      }
      document.getElementById('resultadoRolagem').innerHTML =
        `<div class='mb-2'>${catNome} - <b>${habNome}</b></div>`+
        `<div class='mb-2'>${explicacao}</div>`+
        `<div class='mb-2'>Rolagem: <span class='font-mono text-xl'>${dados.join(' , ')}</span></div>`+
        `<div class='mb-2'>Resultado escolhido: <span class='font-bold text-2xl text-blue-700'>${resultado}</span></div>`;
    };
  </script>
</body>
</html>
